"""
Botanik Medulla ReÃ§ete Takip Botu
Bu bot, Medulla programÄ±nda otomatik reÃ§ete iÅŸlemleri yapar.
"""

import time
from pywinauto import Application, timings
from pywinauto.findwindows import ElementNotFoundError
from pywinauto.keyboard import send_keys
import logging
import ctypes
import win32gui
import win32con
import subprocess
import csv
from pathlib import Path
from datetime import datetime
from timing_settings import get_timing_settings

# pywinauto hÄ±zlandÄ±rma - tÃ¼m internal timing'leri 2'ye bÃ¶l
# Bu, pywinauto'nun kendi bekleme sÃ¼relerini optimize eder (element bulma vs.)
timings.Timings.fast()

# Logging ayarlarÄ± - Saat:Dakika:Saniye:Milisaniye formatÄ±
class MillisecondFormatter(logging.Formatter):
    """Milisaniye + Ã¶nceki satÄ±rdan geÃ§en sÃ¼re iÃ§eren Ã¶zel formatter"""
    _last_time = None

    def formatTime(self, record, datefmt=None):
        from datetime import datetime
        ct = datetime.fromtimestamp(record.created)
        s = ct.strftime("%H:%M:%S")
        s = f"{s}.{int(record.msecs):03d}"

        # Ã–nceki satÄ±rdan geÃ§en sÃ¼reyi hesapla (her zaman saniye cinsinden)
        if MillisecondFormatter._last_time is not None:
            delta = record.created - MillisecondFormatter._last_time
            s = f"{s} (+{delta:.2f}s)"
        else:
            s = f"{s} (start)"

        MillisecondFormatter._last_time = record.created
        return s

# Root logger'Ä± temizle ve yeniden yapÄ±landÄ±r
root_logger = logging.getLogger()
# Eski handler'larÄ± kaldÄ±r
for handler in root_logger.handlers[:]:
    root_logger.removeHandler(handler)

# Console handler oluÅŸtur
console_handler = logging.StreamHandler()
console_handler.setFormatter(MillisecondFormatter('%(asctime)s: %(message)s'))

# Dosya handler oluÅŸtur (TÃœM loglarÄ± kaydet - Y butonu, konsol, vs)
import os
script_dir = os.path.dirname(os.path.abspath(__file__))
debug_log_path = os.path.join(script_dir, 'botanik_debug.log')
file_handler = logging.FileHandler(debug_log_path, mode='a', encoding='utf-8')
file_handler.setFormatter(MillisecondFormatter('%(asctime)s: %(message)s'))

# Root logger'Ä± yapÄ±landÄ±r
root_logger.setLevel(logging.INFO)
root_logger.addHandler(console_handler)
root_logger.addHandler(file_handler)  # Dosyaya da yaz

logger = logging.getLogger(__name__)


# ==================== CUSTOM EXCEPTIONS ====================
class SistemselHataException(Exception):
    """MEDULA'da sistemsel hata oluÅŸtuÄŸunda fÄ±rlatÄ±lan exception"""
    pass


class RaporTakip:
    """
    Hasta rapor bilgilerini CSV dosyasÄ±na kaydeder.

    CSV FormatÄ±:
    Ad Soyad,Telefon,Rapor TanÄ±sÄ±,BitiÅŸ Tarihi,KayÄ±t Tarihi,KopyalandÄ±

    Her rapor ayrÄ± bir satÄ±r olarak kaydedilir.
    Bir hastanÄ±n birden fazla raporu varsa, hasta bilgileri her satÄ±rda tekrar eder.
    """

    def __init__(self, dosya_yolu="rapor_takip.csv"):
        """
        RaporTakip sÄ±nÄ±fÄ±nÄ± baÅŸlatÄ±r ve CSV dosyasÄ±nÄ± hazÄ±rlar.

        Args:
            dosya_yolu: CSV dosyasÄ±nÄ±n yolu (varsayÄ±lan: rapor_takip.csv)
        """
        # DosyayÄ± script'in bulunduÄŸu dizine kaydet
        import os
        script_dir = os.path.dirname(os.path.abspath(__file__))
        self.dosya_yolu = Path(script_dir) / dosya_yolu
        self.toplam_kayit = 0  # Bu oturum boyunca kaydedilen toplam rapor sayÄ±sÄ±
        self.mevcut_kayitlar = set()  # CSV'deki tÃ¼m kayÄ±tlarÄ±n hash'leri (tekrar Ã¶nleme iÃ§in)
        self._dosyayi_baslat()

    def _dosyayi_baslat(self):
        """CSV dosyasÄ±nÄ± oluÅŸturur ve header ekler (eÄŸer dosya yoksa).
        Varsa mevcut kayÄ±tlarÄ± okuyup belleÄŸe yÃ¼kler (tekrar Ã¶nlemek iÃ§in)."""
        if not self.dosya_yolu.exists():
            try:
                with open(self.dosya_yolu, 'w', newline='', encoding='utf-8-sig') as f:
                    writer = csv.writer(f)
                    writer.writerow(['Ad Soyad', 'Telefon', 'Rapor TanÄ±sÄ±', 'BitiÅŸ Tarihi', 'KayÄ±t Tarihi', 'KopyalandÄ±'])
                logger.info(f"âœ“ Rapor takip dosyasÄ± oluÅŸturuldu: {self.dosya_yolu}")
            except Exception as e:
                logger.error(f"CSV dosyasÄ± oluÅŸturma hatasÄ±: {e}")
        else:
            # Dosya var, Ã¶nce eski formattaysa gÃ¼ncelle
            self._eski_csv_guncelle()
            # Sonra mevcut kayÄ±tlarÄ± oku (tekrar kontrolÃ¼ iÃ§in)
            self._mevcut_kayitlari_yukle()

    def _eski_csv_guncelle(self):
        """Eski CSV dosyalarÄ±na 'KopyalandÄ±' sÃ¼tunu ekle (migration)"""
        try:
            with open(self.dosya_yolu, 'r', newline='', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)
                header = reader.fieldnames

                # KopyalandÄ± sÃ¼tunu zaten var mÄ±?
                if 'KopyalandÄ±' in header:
                    return  # GÃ¼ncelleme gerekmez

                # Eski format - tÃ¼m satÄ±rlarÄ± oku
                satirlar = list(reader)

            # Yeni header oluÅŸtur
            yeni_header = list(header) + ['KopyalandÄ±']

            # Yeni formatta yaz
            with open(self.dosya_yolu, 'w', newline='', encoding='utf-8-sig') as f:
                writer = csv.DictWriter(f, fieldnames=yeni_header)
                writer.writeheader()

                for row in satirlar:
                    row['KopyalandÄ±'] = ''  # BoÅŸ olarak ekle
                    writer.writerow(row)

            logger.info("  â„¹ï¸ CSV dosyasÄ± yeni formata gÃ¼ncellendi (KopyalandÄ± sÃ¼tunu eklendi)")

        except Exception as e:
            logger.debug(f"CSV gÃ¼ncelleme hatasÄ± (normal olabilir): {e}")

    def _mevcut_kayitlari_yukle(self):
        """CSV'den tÃ¼m kayÄ±tlarÄ± okuyup belleÄŸe yÃ¼kler (tekrar Ã¶nlemek iÃ§in)."""
        try:
            with open(self.dosya_yolu, 'r', newline='', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    # Kontrol anahtarÄ±: ad+telefon+tanÄ±+bitiÅŸ tarihi (kayÄ±t tarihi dahil DEÄÄ°L)
                    kayit_anahtari = f"{row['Ad Soyad']}|{row['Telefon']}|{row['Rapor TanÄ±sÄ±']}|{row['BitiÅŸ Tarihi']}"
                    self.mevcut_kayitlar.add(kayit_anahtari)

            if self.mevcut_kayitlar:
                logger.info(f"  â„¹ï¸ {len(self.mevcut_kayitlar)} mevcut kayÄ±t yÃ¼klendi (tekrar Ã¶nleme iÃ§in)")
        except Exception as e:
            logger.debug(f"Mevcut kayÄ±tlar yÃ¼klenemedi: {e}")

    def rapor_ekle(self, ad_soyad, telefon, tani, bitis_tarihi):
        """
        Tek bir rapor kaydÄ± ekler.
        AynÄ± (ad+telefon+tanÄ±+bitiÅŸ tarihi) kombinasyonu daha Ã¶nce eklenmiÅŸse atlar.

        Args:
            ad_soyad: Hasta adÄ± soyadÄ±
            telefon: Telefon numarasÄ± (temizlenmiÅŸ format)
            tani: Rapor tanÄ±sÄ±
            bitis_tarihi: Rapor bitiÅŸ tarihi (DD/MM/YYYY formatÄ±nda)

        Returns:
            bool: BaÅŸarÄ±lÄ±ysa True, tekrar ise False
        """
        try:
            # Benzersiz anahtar oluÅŸtur (tekrar kontrolÃ¼ iÃ§in)
            # NOT: KayÄ±t tarihi anahtara DAHÄ°L DEÄÄ°L - aynÄ± rapor hangi gÃ¼n olursa olsun bir kez yazÄ±lÄ±r
            kayit_anahtari = f"{ad_soyad}|{telefon}|{tani}|{bitis_tarihi}"

            # Bu kayÄ±t daha Ã¶nce eklenmiÅŸ mi?
            if kayit_anahtari in self.mevcut_kayitlar:
                logger.debug(f"  â­ AtlandÄ± (daha Ã¶nce eklendi): {ad_soyad} - {tani[:30]}...")
                return False

            kayit_tarihi = datetime.now().strftime("%d/%m/%Y")

            with open(self.dosya_yolu, 'a', newline='', encoding='utf-8-sig') as f:
                writer = csv.writer(f)
                writer.writerow([ad_soyad, telefon, tani, bitis_tarihi, kayit_tarihi, ""])

            # Bu anahtarÄ± kaydet (tekrar yazÄ±lmasÄ±n)
            self.mevcut_kayitlar.add(kayit_anahtari)
            self.toplam_kayit += 1
            return True
        except Exception as e:
            logger.error(f"Rapor ekleme hatasÄ±: {e}")
            return False

    def toplu_rapor_ekle(self, ad_soyad, telefon, raporlar_listesi):
        """
        AynÄ± hasta iÃ§in birden fazla rapor ekler.
        AynÄ± bitiÅŸ tarihine sahip raporlarÄ± birleÅŸtirip tanÄ±larÄ± yan yana dizer.

        Args:
            ad_soyad: Hasta adÄ± soyadÄ±
            telefon: Telefon numarasÄ± (temizlenmiÅŸ format)
            raporlar_listesi: [{"tani": str, "bitis_tarihi": str}, ...] formatÄ±nda rapor listesi

        Returns:
            int: Kaydedilen rapor sayÄ±sÄ±
        """
        # AynÄ± bitiÅŸ tarihine sahip raporlarÄ± grupla
        from collections import defaultdict
        tarih_gruplari = defaultdict(list)

        for rapor in raporlar_listesi:
            tarih_gruplari[rapor["bitis_tarihi"]].append(rapor["tani"])

        # Her tarih iÃ§in birleÅŸtirilmiÅŸ rapor oluÅŸtur
        kayit_sayisi = 0
        atlanan_sayisi = 0

        for bitis_tarihi, tanilar in tarih_gruplari.items():
            # TanÄ±larÄ± " + " ile birleÅŸtir
            birlesik_tani = " + ".join(tanilar)

            if self.rapor_ekle(ad_soyad, telefon, birlesik_tani, bitis_tarihi):
                kayit_sayisi += 1
            else:
                atlanan_sayisi += 1

        if kayit_sayisi > 0:
            logger.info(f"  âœ“ {kayit_sayisi} satÄ±r ({len(raporlar_listesi)} rapor) CSV'ye kaydedildi")

        if atlanan_sayisi > 0:
            logger.info(f"  â­ {atlanan_sayisi} satÄ±r atlandÄ± (tekrar)")

        return kayit_sayisi

    def kopyalanmamis_raporlari_al(self):
        """
        HenÃ¼z kopyalanmamÄ±ÅŸ (KopyalandÄ± sÃ¼tunu boÅŸ) ve tarihi geÃ§memiÅŸ raporlarÄ± dÃ¶ndÃ¼rÃ¼r.

        Returns:
            tuple: (gecerli_raporlar_listesi, silinen_sayisi)
                   gecerli_raporlar_listesi: [{ad, telefon, tani, bitis, kayit}, ...]
                   silinen_sayisi: Tarihi geÃ§miÅŸ rapor sayÄ±sÄ±
        """
        try:
            bugun = datetime.now().date()
            gecerli_raporlar = []
            silinen_sayisi = 0

            with open(self.dosya_yolu, 'r', newline='', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)

                for row in reader:
                    try:
                        # Tarihi kontrol et
                        bitis_str = row['BitiÅŸ Tarihi']
                        bitis_tarihi = datetime.strptime(bitis_str, "%d/%m/%Y").date()

                        if bitis_tarihi < bugun:
                            silinen_sayisi += 1
                            continue

                        # KopyalandÄ± mÄ± kontrol et
                        kopyalandi = row.get('KopyalandÄ±', '').strip()
                        if not kopyalandi:
                            gecerli_raporlar.append({
                                'ad': row['Ad Soyad'],
                                'telefon': row['Telefon'],
                                'tani': row['Rapor TanÄ±sÄ±'],
                                'bitis': row['BitiÅŸ Tarihi'],
                                'kayit': row['KayÄ±t Tarihi']
                            })
                    except Exception as e:
                        logger.debug(f"SatÄ±r parse hatasÄ±: {e}")
                        continue

            return gecerli_raporlar, silinen_sayisi

        except Exception as e:
            logger.error(f"KopyalanmamÄ±ÅŸ raporlar okunurken hata: {e}")
            return [], 0

    def kopyalandi_isaretle(self, raporlar_listesi):
        """
        Verilen raporlarÄ±n KopyalandÄ± sÃ¼tununa bugÃ¼nÃ¼n tarihini yazar.
        Atomic write kullanÄ±larak data loss Ã¶nlenir.

        Args:
            raporlar_listesi: [{ad, telefon, tani, bitis, kayit}, ...] formatÄ±nda rapor listesi

        Returns:
            int: Ä°ÅŸaretlenen rapor sayÄ±sÄ±
        """
        import tempfile
        import shutil

        try:
            bugun = datetime.now().strftime("%d/%m/%Y")
            isaretlenen_sayisi = 0

            # TÃ¼m raporlarÄ± oku
            tum_satirlar = []
            with open(self.dosya_yolu, 'r', newline='', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)
                header = reader.fieldnames

                for row in reader:
                    tum_satirlar.append(row)

            # Ä°ÅŸaretlenecek raporlarÄ±n anahtarlarÄ±nÄ± oluÅŸtur
            isaretlenecekler = set()
            for rapor in raporlar_listesi:
                anahtar = f"{rapor['ad']}|{rapor['telefon']}|{rapor['tani']}|{rapor['bitis']}"
                isaretlenecekler.add(anahtar)

            # KopyalandÄ± sÃ¼tununu gÃ¼ncelle
            for row in tum_satirlar:
                anahtar = f"{row['Ad Soyad']}|{row['Telefon']}|{row['Rapor TanÄ±sÄ±']}|{row['BitiÅŸ Tarihi']}"
                if anahtar in isaretlenecekler:
                    row['KopyalandÄ±'] = bugun
                    isaretlenen_sayisi += 1

            # ATOMIC WRITE: Ã–nce temp dosyaya yaz, sonra rename et
            temp_fd, temp_path = tempfile.mkstemp(suffix='.csv', dir=self.dosya_yolu.parent, text=True)
            try:
                with os.fdopen(temp_fd, 'w', newline='', encoding='utf-8-sig') as f:
                    writer = csv.DictWriter(f, fieldnames=header)
                    writer.writeheader()
                    writer.writerows(tum_satirlar)

                # Atomic rename (Windows'ta replace kullan)
                shutil.move(temp_path, self.dosya_yolu)
                logger.debug(f"âœ“ CSV atomik olarak gÃ¼ncellendi: {isaretlenen_sayisi} rapor iÅŸaretlendi")

            except Exception as write_error:
                # Hata durumunda temp dosyayÄ± sil
                try:
                    os.unlink(temp_path)
                except OSError as e:
                    logger.debug(f"Temp dosya silme hatasÄ± (non-critical): {e}")
                raise write_error

            return isaretlenen_sayisi

        except Exception as e:
            logger.error(f"KopyalandÄ± iÅŸaretleme hatasÄ±: {e}")
            return 0


class BotanikBot:
    """Medulla programÄ± iÃ§in otomasyon botu"""

    def __init__(self):
        self.app = None
        self.main_window = None
        # Element cache sistemi - performans iÃ§in
        self._element_cache = {}
        self._cache_enabled = True
        # Zamanlama ayarlarÄ±
        self.timing = get_timing_settings()
        # Pencere handle cache - performans optimizasyonu (BotTak7'den)
        self.medula_hwnd = None  # Pencere handle'Ä±
        self.medula_pid = None   # Process ID

    def timed_sleep(self, key, default=0.1):
        """
        AyarlÄ± bekleme sÃ¼resi + istatistik kaydÄ±

        Args:
            key (str): Timing ayar anahtarÄ±
            default (float): VarsayÄ±lan sÃ¼re (bulunamazsa)
        """
        start_time = time.time()
        sleep_duration = self.timing.get(key, default)
        time.sleep(sleep_duration)
        actual_duration = time.time() - start_time

        # Ä°statistik kaydet
        self.timing.kayit_ekle(key, actual_duration)

    def retry_with_popup_check(self, operation_func, operation_name, max_retries=3):
        """
        UI element bulma/tÄ±klama iÅŸlemini 3 kere dene, baÅŸarÄ±sÄ±z olursa:
        1. Popup kontrol et
        2. Ana Sayfa butonuna bas (2-3 kez)
        3. Hala olmazsa MEDULA'yÄ± yeniden baÅŸlat

        Args:
            operation_func: Ã‡alÄ±ÅŸtÄ±rÄ±lacak fonksiyon (parametresiz)
            operation_name: Ä°ÅŸlem adÄ± (log iÃ§in)
            max_retries: Maksimum deneme sayÄ±sÄ±

        Returns:
            bool: BaÅŸarÄ±lÄ±ysa True, baÅŸarÄ±sÄ±zsa False

        Raises:
            SistemselHataException: MEDULA'da sistemsel hata tespit edilirse
        """
        for deneme in range(1, max_retries + 1):
            try:
                # Ã–NEMLÄ°: Her denemeden Ã¶nce sistemsel hata kontrolÃ¼ yap
                if sistemsel_hata_kontrol():
                    logger.error("âš ï¸ Sistemsel hata tespit edildi, MEDULA yeniden baÅŸlatÄ±lacak...")
                    raise SistemselHataException("YazÄ±lÄ±msal veya sistemsel bir hata oluÅŸtu")

                # Ä°ÅŸlemi Ã§alÄ±ÅŸtÄ±r
                sonuc = operation_func()
                if sonuc:
                    if deneme > 1:
                        logger.info(f"âœ“ {operation_name} baÅŸarÄ±lÄ± ({deneme}. denemede)")
                    return True

                # BaÅŸarÄ±sÄ±z oldu
                if deneme < max_retries:
                    logger.warning(f"âš  {operation_name} baÅŸarÄ±sÄ±z (Deneme {deneme}/{max_retries})")

                    # Sistemsel hata kontrolÃ¼ (baÅŸarÄ±sÄ±z iÅŸlem sonrasÄ±)
                    if sistemsel_hata_kontrol():
                        logger.error("âš ï¸ Sistemsel hata tespit edildi, MEDULA yeniden baÅŸlatÄ±lacak...")
                        raise SistemselHataException("YazÄ±lÄ±msal veya sistemsel bir hata oluÅŸtu")

                    # Popup kontrol et ve kapat
                    try:
                        if popup_kontrol_ve_kapat():
                            logger.info(f"âœ“ Popup kapatÄ±ldÄ±, {operation_name} tekrar deneniyor...")
                            self.timed_sleep("retry_after_popup", 0.3)
                    except Exception as e:
                        logger.debug(f"Popup kontrol hatasÄ±: {e}")

                    # 2. denemede Ana Sayfa butonuna bas
                    if deneme == 2:
                        logger.warning("ğŸ”„ Ana Sayfa butonuna basÄ±lÄ±yor (kurtarma denemesi)...")
                        for _ in range(2):
                            try:
                                self.ana_sayfaya_don()
                                time.sleep(0.5)
                            except Exception:
                                pass

                    # Pencereyi yenile
                    try:
                        self.baglanti_kur("MEDULA", ilk_baglanti=False)
                        self.timed_sleep("retry_after_reconnect", 0.3)
                    except Exception as e:
                        logger.warning(f"Reconnect baÅŸarÄ±sÄ±z: {type(e).__name__}: {e}")

                else:
                    # 3 deneme de baÅŸarÄ±sÄ±z - MEDULA'yÄ± yeniden baÅŸlat
                    logger.error(f"âŒ {operation_name} baÅŸarÄ±sÄ±z ({max_retries} deneme)")
                    logger.warning("ğŸ”„ MEDULA yeniden baÅŸlatÄ±lÄ±yor (sÃ¼reÃ§ takÄ±ldÄ±)...")
                    raise SistemselHataException(f"{operation_name} 3 denemede baÅŸarÄ±sÄ±z - sistem yeniden baÅŸlatÄ±lacak")

            except SistemselHataException:
                # Sistemsel hata exception'Ä±nÄ± yukarÄ±ya fÄ±rlat
                raise
            except Exception as e:
                if deneme < max_retries:
                    logger.warning(f"âš  {operation_name} hata (Deneme {deneme}/{max_retries}): {e}")
                    self.timed_sleep("retry_after_error", 0.3)
                else:
                    logger.error(f"âŒ {operation_name} hata ({max_retries} deneme): {e}")
                    raise SistemselHataException(f"{operation_name} 3 denemede baÅŸarÄ±sÄ±z - sistem yeniden baÅŸlatÄ±lacak")

        return False

    def baglanti_kur(self, pencere_basligi="MEDULA", ilk_baglanti=False):
        """
        Medulla programÄ±na baÄŸlan (handle cache ile optimize edilmiÅŸ - BotTak7'den)

        Args:
            pencere_basligi (str): Medulla penceresinin baÅŸlÄ±ÄŸÄ±
            ilk_baglanti (bool): Ä°lk baÄŸlantÄ± mÄ±? (pencere yerleÅŸtirme iÃ§in)

        Returns:
            bool: BaÄŸlantÄ± baÅŸarÄ±lÄ± ise True
        """
        try:
            # âœ¨ YENÄ°: Cache'lenmiÅŸ handle varsa ve pencere hala aÃ§Ä±ksa, direkt kullan (Ã§ok daha hÄ±zlÄ±!)
            if self.medula_hwnd and not ilk_baglanti:
                try:
                    # Pencere hala aÃ§Ä±k mÄ± kontrol et
                    if win32gui.IsWindow(self.medula_hwnd):
                        from pywinauto import Desktop
                        desktop = Desktop(backend="uia")
                        # Handle ile direkt baÄŸlan (5-10x daha hÄ±zlÄ±!)
                        self.main_window = desktop.window(handle=self.medula_hwnd)
                        logger.debug("âœ“ Cache'lenmiÅŸ pencere kullanÄ±ldÄ± (hÄ±zlÄ±)")
                        return True
                    else:
                        # Pencere kapalÄ±, cache'i temizle
                        logger.debug("Cache'lenmiÅŸ pencere kapalÄ±, yeniden aranacak")
                        self.medula_hwnd = None
                        self.medula_pid = None
                except Exception as e:
                    logger.debug(f"Cache'lenmiÅŸ pencere kullanÄ±lamadÄ±: {e}")
                    self.medula_hwnd = None
                    self.medula_pid = None

            if ilk_baglanti:
                logger.debug(f"'{pencere_basligi}' aranÄ±yor...")

            # Mevcut pencereye baÄŸlan (birden fazla varsa ilkini al)
            from pywinauto import Desktop
            windows = Desktop(backend="uia").windows()

            medula_window = None
            for window in windows:
                try:
                    if pencere_basligi in window.window_text():
                        medula_window = window
                        break
                except Exception as e:
                    logger.debug(f"Pencere kontrolÃ¼ hatasÄ± (devam ediliyor): {e}")

            if medula_window is None:
                raise ElementNotFoundError(f"'{pencere_basligi}' bulunamadÄ±")

            self.main_window = medula_window

            # âœ¨ YENÄ°: Handle ve PID'yi cache'e kaydet (gelecekte hÄ±zlÄ± baÄŸlantÄ± iÃ§in)
            try:
                self.medula_hwnd = self.main_window.handle
                self.medula_pid = self.main_window.process_id()
                logger.debug(f"Pencere handle cache'lendi: {self.medula_hwnd}")
            except Exception as e:
                logger.debug(f"Handle cache'leme hatasÄ± (normal): {e}")

            if ilk_baglanti:
                logger.info("âœ“ MEDULA'ya baÄŸlandÄ±")

            # Pencereyi sol %80'e yerleÅŸtir (sadece ilk baÄŸlantÄ±da)
            if ilk_baglanti:
                try:
                    # Ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ al
                    user32 = ctypes.windll.user32
                    screen_width = user32.GetSystemMetrics(0)
                    screen_height = user32.GetSystemMetrics(1)

                    # Sol %80 boyutlandÄ±rma - sola tam dayalÄ±
                    medula_x = 0  # Sola tam dayalÄ±
                    medula_y = 0  # Ãœstten baÅŸla
                    medula_width = int(screen_width * 0.8)  # GeniÅŸlik %80
                    medula_height = screen_height - 40  # Taskbar iÃ§in alttan boÅŸluk

                    # Pencere handle'Ä±nÄ± al
                    medula_hwnd = self.main_window.handle

                    # EÄŸer maximize ise Ã¶nce restore et
                    try:
                        placement = win32gui.GetWindowPlacement(medula_hwnd)
                        if placement[1] == win32con.SW_SHOWMAXIMIZED:
                            win32gui.ShowWindow(medula_hwnd, win32con.SW_RESTORE)
                            self.timed_sleep("pencere_restore")
                    except Exception as e:
                        logger.debug(f"Pencere restore hatasÄ±: {type(e).__name__}: {e}")

                    # Pencereyi direkt MoveWindow ile yerleÅŸtir
                    win32gui.MoveWindow(medula_hwnd, medula_x, medula_y, medula_width, medula_height, True)
                    self.timed_sleep("pencere_move")

                    # Ä°kinci kez ayarla (bazÄ± programlar ilk seferde tam oturmuyor)
                    win32gui.MoveWindow(medula_hwnd, medula_x, medula_y, medula_width, medula_height, True)

                    logger.info(f"âœ“ MEDULA sol %80'e yerleÅŸti ({medula_width}x{medula_height})")

                except Exception as e:
                    logger.error(f"Pencere boyutlandÄ±rÄ±lamadÄ±: {e}", exc_info=True)

            return True

        except ElementNotFoundError:
            logger.error(f"'{pencere_basligi}' penceresi bulunamadÄ±!")
            logger.info("LÃ¼tfen Medulla programÄ±nÄ±n aÃ§Ä±k olduÄŸundan emin olun.")
            return False
        except Exception as e:
            logger.error(f"BaÄŸlantÄ± hatasÄ±: {e}")
            return False

    def _get_cached_element(self, cache_key):
        """
        Cache'den element al

        Args:
            cache_key (str): Cache anahtarÄ±

        Returns:
            Element veya None
        """
        if not self._cache_enabled:
            return None

        if cache_key in self._element_cache:
            try:
                element = self._element_cache[cache_key]
                # Element hala geÃ§erli mi kontrol et
                _ = element.window_text()
                return element
            except Exception as e:
                # Element artÄ±k geÃ§ersiz, cache'den sil
                logger.debug(f"Cache element geÃ§ersiz ({cache_key}): {type(e).__name__}")
                del self._element_cache[cache_key]
                return None
        return None

    def _cache_element(self, cache_key, element):
        """
        Elementi cache'e ekle

        Args:
            cache_key (str): Cache anahtarÄ±
            element: Cache'lenecek element
        """
        if self._cache_enabled and element is not None:
            self._element_cache[cache_key] = element

    def _clear_cache(self):
        """TÃ¼m cache'i temizle"""
        self._element_cache.clear()
        logger.debug("ğŸ—‘ï¸ Element cache temizlendi")

    def _clear_cache_key(self, cache_key):
        """Belirli bir cache anahtarÄ±nÄ± temizle"""
        if cache_key in self._element_cache:
            del self._element_cache[cache_key]

    def ilac_butonuna_tikla(self):
        """
        Ä°laÃ§ butonuna tÄ±kla (CACHE KAPALI - web kontrolÃ¼ deÄŸiÅŸken)
        OPTIMIZE: child_window() ile direkt arama (hÄ±zlÄ±), fallback ile gÃ¼venli

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.debug("Ä°laÃ§ butonu aranÄ±yor...")

            # OPTIMIZE: Ã–nce child_window() ile hÄ±zlÄ± arama
            try:
                ilac_button = self.main_window.child_window(
                    auto_id="f:buttonIlacListesi",
                    control_type="Button"
                )
                if ilac_button.exists(timeout=0.5):
                    ilac_button.click_input()
                    logger.info("âœ“ Ä°laÃ§ butonuna tÄ±klandÄ± (Method 1: auto_id)")
                    self.timed_sleep("ilac_butonu")
                    return True
                else:
                    logger.debug("Method 1 (auto_id) baÅŸarÄ±sÄ±z: Element bulunamadÄ±")
            except Exception as e:
                logger.debug(f"Method 1 (auto_id) hatasÄ±: {type(e).__name__}: {e}")

            # OPTIMIZE: Title ile hÄ±zlÄ± arama
            try:
                ilac_button = self.main_window.child_window(
                    title="Ä°laÃ§",
                    control_type="Button"
                )
                if ilac_button.exists(timeout=0.5):
                    try:
                        ilac_button.invoke()
                    except Exception as e1:
                        logger.debug(f"invoke() baÅŸarÄ±sÄ±z: {e1}, click() deneniyor")
                        try:
                            ilac_button.click()
                        except Exception as e2:
                            logger.debug(f"click() baÅŸarÄ±sÄ±z: {e2}, click_input() deneniyor")
                            ilac_button.click_input()

                    logger.info("âœ“ Ä°laÃ§ butonuna tÄ±klandÄ± (Method 2: title)")
                    self.timed_sleep("ilac_butonu")
                    return True
                else:
                    logger.debug("Method 2 (title) baÅŸarÄ±sÄ±z: Element bulunamadÄ±")
            except Exception as e:
                logger.debug(f"Method 2 (title) hatasÄ±: {type(e).__name__}: {e}")

            # FALLBACK: Eski yÃ¶ntem (descendants) - daha yavaÅŸ ama gÃ¼venli
            try:
                ilac_button = self.main_window.descendants(auto_id="f:buttonIlacListesi", control_type="Button")
                if ilac_button and len(ilac_button) > 0:
                    ilac_button[0].click_input()
                    logger.info("âœ“ Ä°laÃ§ butonuna tÄ±klandÄ± (Method 3: descendants auto_id)")
                    self.timed_sleep("ilac_butonu")
                    return True
                else:
                    logger.debug(f"Method 3 (descendants auto_id) baÅŸarÄ±sÄ±z: {len(ilac_button) if ilac_button else 0} element bulundu")
            except Exception as e:
                logger.debug(f"Method 3 (descendants auto_id) hatasÄ±: {type(e).__name__}: {e}")

            # FALLBACK: Name ile ara
            try:
                ilac_button = self.main_window.descendants(title="Ä°laÃ§", control_type="Button")
                if ilac_button and len(ilac_button) > 0:
                    try:
                        ilac_button[0].invoke()
                    except Exception as e1:
                        logger.debug(f"invoke() baÅŸarÄ±sÄ±z: {e1}, click() deneniyor")
                        try:
                            ilac_button[0].click()
                        except Exception as e2:
                            logger.debug(f"click() baÅŸarÄ±sÄ±z: {e2}, click_input() deneniyor")
                            ilac_button[0].click_input()

                    logger.info("âœ“ Ä°laÃ§ butonuna tÄ±klandÄ± (Method 4: descendants title)")
                    self.timed_sleep("ilac_butonu")
                    return True
                else:
                    logger.debug(f"Method 4 (descendants title) baÅŸarÄ±sÄ±z: {len(ilac_button) if ilac_button else 0} element bulundu")
            except Exception as e:
                logger.debug(f"Method 4 (descendants title) hatasÄ±: {type(e).__name__}: {e}")

            logger.error("âŒ Ä°laÃ§ butonu bulunamadÄ± - TÃ¼m 4 method baÅŸarÄ±sÄ±z oldu")
            return False

        except Exception as e:
            logger.error(f"âŒ Ä°laÃ§ butonu hatasÄ±: {e}")
            return False

    def ilac_ekrani_yuklendi_mi(self, max_bekleme=3):
        """
        "KullanÄ±lan Ä°laÃ§ Listesi" ekranÄ±nÄ±n yÃ¼klenip yÃ¼klenmediÄŸini kontrol et

        Args:
            max_bekleme: Maksimum bekleme sÃ¼resi (saniye)

        Returns:
            bool: Ekran yÃ¼klendi ise True
        """
        try:
            baslangic = time.time()
            check_interval = 0.2  # Optimizasyon: Daha sÄ±k kontrol et

            while time.time() - baslangic < max_bekleme:
                # "KullanÄ±lan Ä°laÃ§ Listesi" yazÄ±sÄ±nÄ± ara
                texts = self.main_window.descendants(control_type="Text")
                for text in texts:
                    try:
                        text_value = text.window_text()
                        if "KullanÄ±lan Ä°laÃ§ Listesi" in text_value or "Kullanilan Ä°laÃ§ Listesi" in text_value:
                            gecen_sure = time.time() - baslangic
                            logger.info(f"âœ“ Ä°laÃ§ ekranÄ± yÃ¼klendi ({gecen_sure:.2f}s)")
                            return True
                    except Exception as e:
                        logger.debug(f"Ä°laÃ§ ekranÄ± kontrolÃ¼ hatasÄ±: {type(e).__name__}")

                # Optimizasyon: Sabit kÄ±sa interval ile bekle
                time.sleep(check_interval)

            logger.warning("âš ï¸ Ä°laÃ§ ekranÄ± yÃ¼klenemedi")
            return False

        except Exception as e:
            logger.error(f"Ekran kontrol hatasÄ±: {e}")
            return False

    def recete_not_penceresini_kapat(self, max_bekleme=0.1):  # HÄ±zlandÄ±rÄ±ldÄ±: 0.2 â†’ 0.1
        """
        "REÃ‡ETE Ä°Ã‡Ä°N NOT" penceresi varsa Kapat butonuna bas

        Args:
            max_bekleme: Maksimum bekleme sÃ¼resi (saniye)

        Returns:
            bool: Pencere kapatÄ±ldÄ±ysa True, bulunamadÄ±ysa False
        """
        try:
            baslangic = time.time()
            anahtar = "REÃ‡ETE Ä°Ã‡Ä°N NOT"

            def kapat_butonunu_bul_ve_tikla(kok):
                if kok is None:
                    return False
                try:
                    buttons = kok.descendants(title="KAPAT", control_type="Button")
                except Exception:
                    buttons = []
                for btn in buttons:
                    try:
                        try:
                            btn.invoke()
                        except Exception:
                            try:
                                btn.click()
                            except Exception:
                                btn.click_input()
                        logger.info("âœ“ REÃ‡ETE Ä°Ã‡Ä°N NOT kapatÄ±ldÄ±")
                        self.timed_sleep("popup_kapat")
                        return True
                    except Exception:
                        continue
                return False

            # Ã–nce mevcut ana pencerede ara
            if self.main_window:
                try:
                    texts = self.main_window.descendants(control_type="Text")
                except Exception:
                    texts = []

                for text in texts:
                    try:
                        icerik = text.window_text() or ""
                    except Exception:
                        continue

                    if anahtar in icerik:
                        hedef = text
                        # Ã–nce bulunduÄŸu konteynerde ara
                        if kapat_butonunu_bul_ve_tikla(hedef.parent()):
                            return True
                        # 3 seviye yukarÄ± Ã§Ä±karak tekrar dene
                        ata = hedef.parent()
                        for _ in range(3):
                            try:
                                ata = ata.parent()
                            except Exception:
                                ata = None
                            if kapat_butonunu_bul_ve_tikla(ata):
                                return True
                        # Ana pencerede tekrar dene
                        if kapat_butonunu_bul_ve_tikla(self.main_window):
                            return True
                        # Hedef bulundu ama kapatÄ±lamadÄ±ysa tekrar arama yapma
                        return False

            # Gerekiyorsa kÄ±sa bir Desktop taramasÄ± yap
            kalan = max_bekleme - (time.time() - baslangic)
            if kalan <= 0:
                return False

            from pywinauto import Desktop
            try:
                windows = Desktop(backend="uia").windows()
            except Exception:
                return False

            for window in windows:
                try:
                    texts = window.descendants(control_type="Text")
                except Exception:
                    continue

                hedef_bulundu = False
                for text in texts:
                    try:
                        if anahtar in (text.window_text() or ""):
                            hedef_bulundu = True
                            break
                    except Exception:
                        continue

                if not hedef_bulundu:
                    continue

                if kapat_butonunu_bul_ve_tikla(window):
                    return True

            return False

        except Exception as e:
            logger.error(f"REÃ‡ETE Ä°Ã‡Ä°N NOT kapatma hatasÄ±: {e}")
            return False

    def uyari_penceresini_kapat(self, max_bekleme=0.1):
        """
        "UYARIDIR" veya "GENEL MUAYENE TANISI" iÃ§eren uyarÄ± pencerelerini "Kapat" butonuna tÄ±klayarak kapat

        Args:
            max_bekleme: Maksimum bekleme sÃ¼resi (saniye)

        Returns:
            bool: Pencere kapatÄ±ldÄ±ysa True, bulunamadÄ±ysa False
        """
        try:
            baslangic = time.time()
            anahtar_ifadeler = ["UYARIDIR", "GENEL MUAYENE TANISI VARDIR", "ICD EKLEME GEREKLÄ°"]

            def kapat_butonunu_bul_ve_tikla(kok):
                if kok is None:
                    return False
                try:
                    # "Kapat" butonunu ara
                    buttons = kok.descendants(title="Kapat", control_type="Button")
                except Exception:
                    buttons = []
                for btn in buttons:
                    try:
                        try:
                            btn.invoke()
                        except Exception:
                            try:
                                btn.click()
                            except Exception:
                                btn.click_input()
                        logger.info("âœ“ UyarÄ± penceresi kapatÄ±ldÄ±")
                        self.timed_sleep("uyari_kapat")
                        return True
                    except Exception:
                        continue
                return False

            # Ã–nce mevcut ana pencerede ara
            if self.main_window:
                try:
                    texts = self.main_window.descendants(control_type="Text")
                except Exception:
                    texts = []

                for text in texts:
                    try:
                        icerik = (text.window_text() or "").upper()
                    except Exception:
                        continue

                    # Anahtar ifadelerden birini iÃ§eriyorsa
                    if any(anahtar.upper() in icerik for anahtar in anahtar_ifadeler):
                        hedef = text
                        # Ã–nce bulunduÄŸu konteynerde ara
                        if kapat_butonunu_bul_ve_tikla(hedef.parent()):
                            return True
                        # Desktop taramasÄ± yap (WindowsForms penceresi iÃ§in)
                        from pywinauto import Desktop
                        try:
                            windows = Desktop(backend="uia").windows()
                        except Exception:
                            return False

                        for window in windows:
                            try:
                                # WindowsForms class kontrolÃ¼
                                class_name = window.class_name()
                                if "WindowsForms10.Window" not in class_name:
                                    continue
                            except Exception as e:
                                logger.debug(f"class_name kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                                continue

                            # Pencere baÅŸlÄ±ÄŸÄ±nda "UYARIDIR" var mÄ±?
                            try:
                                window_text = window.window_text()
                                if "UYARI" not in window_text.upper():
                                    continue
                                logger.debug(f"  âœ“ Genel Muayene penceresi bulundu (baÅŸlÄ±k: {window_text})")
                            except Exception as e:
                                logger.debug(f"window_text kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                                continue

                            # Kapat butonunu bul
                            try:
                                all_buttons = window.descendants(control_type="Button")
                                kapat_buttons = [
                                    btn for btn in all_buttons
                                    if (text := btn.window_text()) and "KAPAT" in text.upper()
                                ]
                                logger.debug(f"  â†’ {len(kapat_buttons)} Kapat butonu bulundu")
                            except Exception:
                                kapat_buttons = []

                            if not kapat_buttons:
                                # Kapat butonu yoksa window.close() dene
                                try:
                                    window.close()
                                    logger.info("âœ“ Genel Muayene uyarÄ±sÄ± kapatÄ±ldÄ± (close)")
                                    self.timed_sleep("uyari_kapat")
                                    return True
                                except Exception as e:
                                    logger.debug(f"window.close() hatasÄ±: {type(e).__name__}")
                                continue

                            logger.info(f"âš  Genel Muayene uyarÄ±sÄ± bulundu! KapatÄ±lÄ±yor...")

                            for btn in kapat_buttons:
                                try:
                                    try:
                                        btn.invoke()
                                    except Exception:
                                        try:
                                            btn.click()
                                        except Exception:
                                            btn.click_input()
                                    logger.info("âœ“ Genel Muayene uyarÄ±sÄ± kapatÄ±ldÄ±")
                                    self.timed_sleep("uyari_kapat")
                                    return True
                                except Exception:
                                    continue

                        return False

            return False

        except Exception as e:
            logger.error(f"Genel Muayene uyarÄ±sÄ± kapatma hatasÄ±: {e}")
            return False

    def laba_lama_uyarisini_kapat(self, max_bekleme=1.5, detayli_log=True):
        """
        SADECE LABA/LAMA uyarÄ±sÄ±nÄ± "Kapat" butonuna tÄ±klayarak kapat
        inspect.exe'den: class="#32770", Kapat dÃ¼ÄŸmesi

        Args:
            max_bekleme: Maksimum bekleme sÃ¼resi (saniye)
            detayli_log: DetaylÄ± debug loglarÄ± yaz (varsayÄ±lan True)

        Returns:
            bool: UyarÄ± kapatÄ±ldÄ± ise True
        """
        try:
            from pywinauto import Desktop

            if detayli_log:
                logger.debug(f"ğŸ” LABA/LAMA uyarÄ±sÄ± aranÄ±yor (max {max_bekleme}s)...")

            baslangic = time.time()
            # LABA/LAMA uyarÄ±sÄ± iÃ§in anahtar ifadeler
            laba_ifadeler = ("LABA", "LAMA")

            desktop = Desktop(backend="uia")

            while time.time() - baslangic < max_bekleme:
                try:
                    windows = desktop.windows()
                except Exception:
                    windows = []

                for window in windows:
                    try:
                        # class="#32770" kontrolÃ¼
                        class_name = window.class_name()
                        if class_name != "#32770":
                            continue
                    except Exception as e:
                        logger.debug(f"LABA class_name kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                        continue

                    # Ä°Ã§erikte LABA/LAMA ifadesi var mÄ±?
                    try:
                        texts = window.descendants()
                        laba_bulundu = any(
                            any(ifade in (text.window_text() or "").upper() for ifade in laba_ifadeler)
                            for text in texts
                        )
                        if not laba_bulundu:
                            continue
                    except Exception as e:
                        logger.debug(f"LABA/LAMA iÃ§erik kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                        continue

                    if detayli_log:
                        logger.debug(f"  âœ“ LABA/LAMA penceresi bulundu (class=#32770)")

                    logger.info(f"âš  LABA/LAMA uyarÄ±sÄ± bulundu! KapatÄ±lÄ±yor...")

                    # OPTIMIZE: Ã–nce child_window() ile TAMAM butonunu ara (inspect.exe'ye gÃ¶re "Tamam" var)
                    try:
                        tamam_btn = window.child_window(title_re=".*[Tt][Aa][Mm][Aa][Mm].*", control_type="Button")
                        if tamam_btn.exists(timeout=0.3):
                            try:
                                tamam_btn.invoke()
                            except Exception as e:
                                logger.debug(f"tamam_btn.invoke() hatasÄ±: {type(e).__name__}")
                                try:
                                    tamam_btn.click()
                                except Exception as e2:
                                    logger.debug(f"tamam_btn.click() hatasÄ±: {type(e2).__name__}")
                                    tamam_btn.click_input()
                            logger.info(f"âœ“ LABA/LAMA uyarÄ±sÄ± kapatÄ±ldÄ± (Tamam hÄ±zlÄ±)")
                            self.timed_sleep("laba_uyari")
                            return True
                    except Exception as e:
                        logger.debug(f"TAMAM butonu arama hatasÄ±: {type(e).__name__}")

                    # OPTIMIZE: Alternatif - KAPAT butonu ara
                    try:
                        kapat_btn = window.child_window(title_re=".*[Kk][Aa][Pp][Aa][Tt].*", control_type="Button")
                        if kapat_btn.exists(timeout=0.3):
                            try:
                                kapat_btn.invoke()
                            except Exception as e:
                                logger.debug(f"kapat_btn.invoke() hatasÄ±: {type(e).__name__}")
                                try:
                                    kapat_btn.click()
                                except Exception as e2:
                                    logger.debug(f"kapat_btn.click() hatasÄ±: {type(e2).__name__}")
                                    kapat_btn.click_input()
                            logger.info(f"âœ“ LABA/LAMA uyarÄ±sÄ± kapatÄ±ldÄ± (Kapat hÄ±zlÄ±)")
                            self.timed_sleep("laba_uyari")
                            return True
                    except Exception as e:
                        logger.debug(f"KAPAT butonu arama hatasÄ±: {type(e).__name__}")

                    # FALLBACK: descendants() ile TAMAM veya KAPAT ara
                    try:
                        all_buttons = window.descendants(control_type="Button")
                        kapat_buttons = [
                            btn for btn in all_buttons
                            if (text := btn.window_text()) and (
                                "TAMAM" in text.upper() or
                                "KAPAT" in text.upper() or
                                "OK" in text.upper()
                            )
                        ]
                        if detayli_log:
                            logger.debug(f"  â†’ {len(kapat_buttons)} Tamam/Kapat butonu bulundu (fallback)")

                        if kapat_buttons:
                            for btn in kapat_buttons:
                                try:
                                    try:
                                        btn.invoke()
                                    except Exception:
                                        try:
                                            btn.click()
                                        except Exception:
                                            btn.click_input()
                                    logger.info(f"âœ“ LABA/LAMA uyarÄ±sÄ± kapatÄ±ldÄ± (Tamam/Kapat fallback)")
                                    self.timed_sleep("laba_uyari")
                                    return True
                                except Exception:
                                    continue
                    except Exception:
                        pass

                    # Son Ã§are: ENTER tuÅŸu gÃ¶nder (laba/lama popup kapatmak iÃ§in)
                    if detayli_log:
                        logger.debug(f"  âš  Tamam/Kapat butonu bulunamadÄ±, ENTER tuÅŸu gÃ¶nderiliyor...")
                    try:
                        send_keys("{ENTER}")
                        logger.info(f"âœ“ LABA/LAMA uyarÄ±sÄ± kapatÄ±ldÄ± (ENTER)")
                        self.timed_sleep("laba_uyari")
                        return True
                    except Exception as e:
                        logger.debug(f"ENTER gÃ¶nderme hatasÄ± (LABA): {type(e).__name__}")
                        # ENTER de Ã§alÄ±ÅŸmazsa pencereyi direkt kapat
                        try:
                            window.close()
                            logger.info(f"âœ“ LABA/LAMA uyarÄ±sÄ± kapatÄ±ldÄ± (close)")
                            self.timed_sleep("laba_uyari")
                            return True
                        except Exception as e2:
                            logger.debug(f"window.close() hatasÄ± (LABA): {type(e2).__name__}")

                self.timed_sleep("popup_kapat")

            return False

        except Exception as e:
            logger.error(f"LABA/LAMA uyarÄ±sÄ± kontrol hatasÄ±: {e}", exc_info=True)
            return False

    def ilac_cakismasi_uyarisini_kapat(self, max_bekleme=1.5, detayli_log=True):
        """
        SADECE Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ±nÄ± "Kapat" butonuna tÄ±klayarak kapat
        inspect.exe'den: class="#32770", Kapat dÃ¼ÄŸmesi

        Args:
            max_bekleme: Maksimum bekleme sÃ¼resi (saniye)
            detayli_log: DetaylÄ± debug loglarÄ± yaz (varsayÄ±lan True)

        Returns:
            bool: UyarÄ± kapatÄ±ldÄ± ise True
        """
        try:
            from pywinauto import Desktop

            if detayli_log:
                logger.debug(f"ğŸ” Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± aranÄ±yor (max {max_bekleme}s)...")

            baslangic = time.time()
            # Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± iÃ§in anahtar ifadeler
            ilac_cakismasi_ifadeler = ("Ä°LAÃ‡ Ã‡AKIÅMASI", "ILAC CAKISMASI", "Ã‡AKIÅMA")

            desktop = Desktop(backend="uia")

            while time.time() - baslangic < max_bekleme:
                try:
                    windows = desktop.windows()
                except Exception:
                    windows = []

                for window in windows:
                    try:
                        # class="#32770" kontrolÃ¼
                        class_name = window.class_name()
                        if class_name != "#32770":
                            continue
                    except Exception as e:
                        logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± class_name kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                        continue

                    # Ä°Ã§erikte Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± ifadesi var mÄ±?
                    try:
                        texts = window.descendants()
                        ilac_cakismasi_bulundu = any(
                            any(ifade in (text.window_text() or "").upper() for ifade in ilac_cakismasi_ifadeler)
                            for text in texts
                        )
                        if not ilac_cakismasi_bulundu:
                            continue
                    except Exception as e:
                        logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± iÃ§erik kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                        continue

                    if detayli_log:
                        logger.debug(f"  âœ“ Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± penceresi bulundu (class=#32770)")

                    logger.info(f"âš  Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± bulundu! KapatÄ±lÄ±yor...")

                    # OPTIMIZE: Ã–nce child_window() ile TAMAM butonunu ara (inspect.exe'ye gÃ¶re "Tamam" var)
                    try:
                        tamam_btn = window.child_window(title_re=".*[Tt][Aa][Mm][Aa][Mm].*", control_type="Button")
                        if tamam_btn.exists(timeout=0.3):
                            try:
                                tamam_btn.invoke()
                            except Exception as e:
                                logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± tamam_btn.invoke() hatasÄ±: {type(e).__name__}")
                                try:
                                    tamam_btn.click()
                                except Exception as e2:
                                    logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± tamam_btn.click() hatasÄ±: {type(e2).__name__}")
                                    tamam_btn.click_input()
                            logger.info(f"âœ“ Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± kapatÄ±ldÄ± (Tamam hÄ±zlÄ±)")
                            self.timed_sleep("ilac_cakismasi_uyari")
                            return True
                    except Exception as e:
                        logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± TAMAM butonu arama hatasÄ±: {type(e).__name__}")

                    # OPTIMIZE: Alternatif - KAPAT butonu ara
                    try:
                        kapat_btn = window.child_window(title_re=".*[Kk][Aa][Pp][Aa][Tt].*", control_type="Button")
                        if kapat_btn.exists(timeout=0.3):
                            try:
                                kapat_btn.invoke()
                            except Exception as e:
                                logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± kapat_btn.invoke() hatasÄ±: {type(e).__name__}")
                                try:
                                    kapat_btn.click()
                                except Exception as e2:
                                    logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± kapat_btn.click() hatasÄ±: {type(e2).__name__}")
                                    kapat_btn.click_input()
                            logger.info(f"âœ“ Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± kapatÄ±ldÄ± (Kapat hÄ±zlÄ±)")
                            self.timed_sleep("ilac_cakismasi_uyari")
                            return True
                    except Exception as e:
                        logger.debug(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± KAPAT butonu arama hatasÄ±: {type(e).__name__}")

                    # FALLBACK: descendants() ile TAMAM veya KAPAT ara
                    try:
                        all_buttons = window.descendants(control_type="Button")
                        kapat_buttons = [
                            btn for btn in all_buttons
                            if (text := btn.window_text()) and (
                                "TAMAM" in text.upper() or
                                "KAPAT" in text.upper() or
                                "OK" in text.upper()
                            )
                        ]
                        if detayli_log:
                            logger.debug(f"  â†’ {len(kapat_buttons)} Tamam/Kapat butonu bulundu (fallback)")

                        if kapat_buttons:
                            for btn in kapat_buttons:
                                try:
                                    try:
                                        btn.invoke()
                                    except Exception:
                                        try:
                                            btn.click()
                                        except Exception:
                                            btn.click_input()
                                    logger.info(f"âœ“ Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± kapatÄ±ldÄ± (Tamam/Kapat fallback)")
                                    self.timed_sleep("ilac_cakismasi_uyari")
                                    return True
                                except Exception:
                                    continue
                    except Exception:
                        pass

                    # Son Ã§are: Pencereyi direkt kapat
                    if detayli_log:
                        logger.debug(f"  âš  Tamam/Kapat butonu bulunamadÄ±, pencereyi kapatmaya Ã§alÄ±ÅŸÄ±yor...")
                    try:
                        window.close()
                        logger.info(f"âœ“ Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± kapatÄ±ldÄ± (close)")
                        self.timed_sleep("ilac_cakismasi_uyari")
                        return True
                    except Exception as e:
                        logger.debug(f"window.close() hatasÄ± (Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ±): {type(e).__name__}")

                self.timed_sleep("popup_kapat")

            return False

        except Exception as e:
            logger.error(f"Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± kontrol hatasÄ±: {e}", exc_info=True)
            return False

    def y_tusuna_tikla(self):
        """
        Y tuÅŸuna tÄ±kla (CACHE destekli)

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            # Ã–nce cache'den kontrol et
            cached_button = self._get_cached_element("y_button")
            if cached_button:
                try:
                    cached_button.invoke()
                    logger.info("âœ“ Y butonuna tÄ±klandÄ± (cache)")
                    self.timed_sleep("y_butonu")
                    return True
                except Exception as e:
                    logger.debug(f"Cache'den Y butonu invoke() hatasÄ±: {type(e).__name__}")
                    self._clear_cache_key("y_button")

            # OPTIMIZE: child_window() ile hÄ±zlÄ± arama
            try:
                y_button = self.main_window.child_window(title="Y", control_type="Button")
                if y_button.exists(timeout=0.5):
                    self._cache_element("y_button", y_button)  # Cache'e ekle
                    # FarklÄ± tÄ±klama yÃ¶ntemlerini dene
                    try:
                        y_button.invoke()
                        logger.info("âœ“ Y butonuna tÄ±klandÄ± (hÄ±zlÄ±)")
                    except Exception as e:
                        logger.debug(f"Y butonu invoke() hatasÄ±: {type(e).__name__}")
                        try:
                            y_button.click()
                            logger.info("âœ“ Y butonuna tÄ±klandÄ± (hÄ±zlÄ±)")
                        except Exception as e2:
                            logger.debug(f"Y butonu click() hatasÄ±: {type(e2).__name__}")
                            y_button.click_input()
                            logger.info("âœ“ Y butonuna tÄ±klandÄ± (hÄ±zlÄ±)")

                    self.timed_sleep("y_butonu")
                    return True
            except Exception as e:
                logger.debug(f"Y butonu child_window() arama hatasÄ±: {type(e).__name__}")

            # FALLBACK: descendants() ile arama (daha yavaÅŸ ama gÃ¼venli)
            try:
                y_button = self.main_window.descendants(title="Y", control_type="Button")
                if y_button and len(y_button) > 0:
                    self._cache_element("y_button", y_button[0])  # Cache'e ekle
                    try:
                        y_button[0].invoke()
                        logger.info("âœ“ Y butonuna tÄ±klandÄ± (fallback)")
                    except Exception as e:
                        logger.debug(f"Y butonu fallback invoke() hatasÄ±: {type(e).__name__}")
                        try:
                            y_button[0].click()
                            logger.info("âœ“ Y butonuna tÄ±klandÄ± (fallback)")
                        except Exception as e2:
                            logger.debug(f"Y butonu fallback click() hatasÄ±: {type(e2).__name__}")
                            y_button[0].click_input()
                            logger.info("âœ“ Y butonuna tÄ±klandÄ± (fallback)")

                    self.timed_sleep("y_butonu")
                    return True
                else:
                    logger.warning("âš ï¸ Y butonu bulunamadÄ±, ENTER tuÅŸu gÃ¶nderiliyor (laba/lama popup fallback)...")
                    try:
                        send_keys("{ENTER}")
                        self.timed_sleep("y_butonu")
                        logger.info("âœ“ ENTER tuÅŸu gÃ¶nderildi (Y butonu yerine)")
                        return True
                    except Exception as enter_err:
                        logger.error(f"ENTER tuÅŸu gÃ¶nderme hatasÄ±: {enter_err}")
                        return False
            except Exception as e:
                logger.error(f"Y butonu hatasÄ±: {e}")
                logger.warning("âš ï¸ Y butonu arama hatasÄ±, ENTER tuÅŸu gÃ¶nderiliyor...")
                try:
                    send_keys("{ENTER}")
                    self.timed_sleep("y_butonu")
                    logger.info("âœ“ ENTER tuÅŸu gÃ¶nderildi (Y butonu yerine)")
                    return True
                except Exception as enter_err:
                    logger.error(f"ENTER tuÅŸu gÃ¶nderme hatasÄ±: {enter_err}")
                    return False

        except Exception as e:
            logger.error(f"Y tÄ±klama hatasÄ±: {e}")
            logger.warning("âš ï¸ Y butonu iÅŸlemi baÅŸarÄ±sÄ±z, ENTER tuÅŸu gÃ¶nderiliyor...")
            try:
                send_keys("{ENTER}")
                self.timed_sleep("y_butonu")
                logger.info("âœ“ ENTER tuÅŸu gÃ¶nderildi (Y butonu yerine)")
                return True
            except Exception as enter_err:
                logger.error(f"ENTER tuÅŸu gÃ¶nderme hatasÄ±: {enter_err}")
                return False

    def yeni_pencereyi_bul(self, pencere_basligi_iceren="Ä°laÃ§ Listesi"):
        """
        Yeni aÃ§Ä±lan pencereyi bul ve baÄŸlan

        Args:
            pencere_basligi_iceren (str): Pencere baÅŸlÄ±ÄŸÄ±nda aranacak kelime

        Returns:
            bool: Pencere bulundu ise True
        """
        try:
            from pywinauto import Desktop
            windows = Desktop(backend="uia").windows()

            for window in windows:
                try:
                    window_title = window.window_text()
                    if pencere_basligi_iceren in window_title:
                        self.main_window = window
                        return True
                except Exception as e:
                    logger.debug(f"Pencere baÅŸlÄ±ÄŸÄ± kontrolÃ¼ hatasÄ±: {type(e).__name__}")

            logger.warning(f"âŒ '{pencere_basligi_iceren}' bulunamadÄ±")
            return False

        except Exception as e:
            logger.error(f"Pencere arama hatasÄ±: {e}")
            return False

    def bizden_alinanlarin_sec_tusuna_tikla(self):
        """
        Bizden AlÄ±nmayanlarÄ± SeÃ§ butonuna tÄ±kla
        OPTIMIZE: child_window() ile direkt arama (hÄ±zlÄ±), fallback ile gÃ¼venli

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            # OPTIMIZE: child_window() ile hÄ±zlÄ± arama
            try:
                bizden_button = self.main_window.child_window(
                    title_re=".*AlÄ±[nm].*SeÃ§.*",  # "AlÄ±nmayanlarÄ± SeÃ§" veya "AlÄ±nanlarÄ± SeÃ§"
                    control_type="Button"
                )
                if bizden_button.exists(timeout=0.5):
                    try:
                        bizden_button.invoke()
                    except Exception as e:
                        logger.debug(f"Bizden alÄ±nanlar invoke() hatasÄ±: {type(e).__name__}")
                        try:
                            bizden_button.click()
                        except Exception as e2:
                            logger.debug(f"Bizden alÄ±nanlar click() hatasÄ±: {type(e2).__name__}")
                            bizden_button.click_input()

                    logger.info("âœ“ AlÄ±nmayanlarÄ± seÃ§ (hÄ±zlÄ±)")
                    return True
            except Exception as e:
                logger.debug(f"Bizden alÄ±nanlar child_window() arama hatasÄ±: {type(e).__name__}")

            # FALLBACK: descendants() ile arama (daha yavaÅŸ ama gÃ¼venli)
            try:
                buttons = self.main_window.descendants(control_type="Button")
                bizden_button = None

                for btn in buttons:
                    try:
                        btn_text = btn.window_text()
                        if "AlÄ±nmayanlarÄ± SeÃ§" in btn_text or "AlÄ±nanlarÄ± SeÃ§" in btn_text:
                            bizden_button = [btn]
                            break
                    except Exception as e:
                        logger.debug(f"Buton text kontrolÃ¼ hatasÄ±: {type(e).__name__}")
                if bizden_button and len(bizden_button) > 0:
                    try:
                        bizden_button[0].invoke()
                    except Exception as e:
                        logger.debug(f"Bizden alÄ±nanlar fallback invoke() hatasÄ±: {type(e).__name__}")
                        try:
                            bizden_button[0].click()
                        except Exception as e2:
                            logger.debug(f"Bizden alÄ±nanlar fallback click() hatasÄ±: {type(e2).__name__}")
                            bizden_button[0].click_input()

                    logger.info("âœ“ AlÄ±nmayanlarÄ± seÃ§ (fallback)")
                    return True
                else:
                    logger.warning("âŒ AlÄ±nmayanlarÄ± seÃ§ yok")
                    return False
            except Exception as e:
                logger.error(f"Buton arama hatasÄ±: {e}")
                return False

        except Exception as e:
            logger.error(f"TÄ±klama hatasÄ±: {e}")
            return False

    def ilac_secili_mi_kontrol(self):
        """
        Ä°laÃ§lardan herhangi biri seÃ§ili mi kontrol et

        Returns:
            tuple: (bool: En az 1 ilaÃ§ seÃ§ili ise True, int: seÃ§ili ilaÃ§ sayÄ±sÄ±)
        """
        try:
            # TÃ¼m DataItem'larÄ± bul
            cells = self.main_window.descendants(control_type="DataItem")

            secili_sayisi = 0
            toplam_ilac = 0

            for cell in cells:
                try:
                    cell_name = cell.window_text()
                    if "SeÃ§im satÄ±r" in cell_name:
                        toplam_ilac += 1

                        # FarklÄ± yÃ¶ntemlerle seÃ§ilim kontrolÃ¼
                        secili = False

                        # YÃ¶ntem 1: Value Ã¶zelliÄŸini kontrol et
                        try:
                            value = cell.legacy_properties().get('Value', '')
                            if value == "SeÃ§ili":
                                secili = True
                        except Exception as e:
                            logger.debug(f"Operation failed: {type(e).__name__}")

                        # YÃ¶ntem 2: Toggle state
                        try:
                            toggle_state = cell.get_toggle_state()
                            if toggle_state == 1:
                                secili = True
                        except Exception as e:
                            logger.debug(f"Operation failed: {type(e).__name__}")

                        if secili:
                            secili_sayisi += 1

                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            logger.info(f"â†’ {secili_sayisi}/{toplam_ilac} ilaÃ§ seÃ§ili")

            return (secili_sayisi > 0, secili_sayisi)

        except Exception as e:
            logger.error(f"Ä°laÃ§ seÃ§ilim kontrolÃ¼ hatasÄ±: {e}")
            return (False, 0)

    def ilk_ilaca_sag_tik_ve_takip_et(self):
        """
        Ä°lk ilaca (SeÃ§im satÄ±r 1) saÄŸ tÄ±kla ve "Takip Et" seÃ§

        Returns:
            bool: Ä°ÅŸlem baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.info("Ä°lk ilaca saÄŸ tÄ±klama yapÄ±lÄ±yor...")

            # "SeÃ§im satÄ±r 1" hÃ¼cresini bul
            cells = self.main_window.descendants(control_type="DataItem")

            ilk_ilac = None
            for cell in cells:
                try:
                    cell_name = cell.window_text()
                    if "SeÃ§im satÄ±r 1" in cell_name:
                        ilk_ilac = cell
                        logger.info(f"Ä°lk ilaÃ§ bulundu: {cell_name}")
                        break
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            if ilk_ilac is None:
                logger.error("Ä°lk ilaÃ§ bulunamadÄ±")
                return False

            # SaÄŸ tÄ±k yap
            ilk_ilac.click_input(button='right')
            self.timed_sleep("sag_tik")

            # "Takip Et" menÃ¼ Ã¶ÄŸesini bul ve tÄ±kla
            try:
                # MenÃ¼ Ã¶ÄŸelerini bul
                menu_items = self.main_window.descendants(control_type="MenuItem")

                for item in menu_items:
                    try:
                        item_name = item.window_text()
                        if "Takip Et" in item_name:
                            item.click_input()
                            logger.info("âœ“ Takip Et tÄ±klandÄ±")
                            self.timed_sleep("takip_et")
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                logger.error("âŒ Takip Et bulunamadÄ±")
                return False

            except Exception as e:
                logger.error(f"MenÃ¼ Ã¶ÄŸesi arama hatasÄ±: {e}")
                return False

        except Exception as e:
            logger.error(f"SaÄŸ tÄ±klama hatasÄ±: {e}")
            return False

    def ilac_listesi_penceresini_kapat(self):
        """
        Ä°laÃ§ Listesi penceresini kapat
        OPTIMIZE: child_window() ile direkt arama (hÄ±zlÄ±), fallback ile gÃ¼venli

        Returns:
            bool: Kapatma baÅŸarÄ±lÄ± ise True
        """
        try:
            # OPTIMIZE: child_window() ile hÄ±zlÄ± arama
            try:
                kapat_btn = self.main_window.child_window(title="Kapat", control_type="Button")
                if kapat_btn.exists(timeout=0.5):
                    kapat_btn.click_input()
                    logger.info("âœ“ Pencere kapatÄ±ldÄ± (hÄ±zlÄ±)")
                    self.timed_sleep("kapat_butonu")
                    return True
            except Exception as e:
                logger.debug(f"Operation failed: {type(e).__name__}")

            # FALLBACK: descendants() ile arama (daha yavaÅŸ ama gÃ¼venli)
            buttons = self.main_window.descendants(control_type="Button")

            for btn in buttons:
                try:
                    btn_name = btn.window_text()
                    if btn_name == "Kapat":
                        btn.click_input()
                        logger.info("âœ“ Pencere kapatÄ±ldÄ± (fallback)")
                        self.timed_sleep("kapat_butonu")
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            logger.warning("âŒ Kapat butonu yok")
            return False

        except Exception as e:
            logger.error(f"Pencere kapatma hatasÄ±: {e}")
            return False

    def geri_don_butonuna_tikla(self):
        """
        Ana Medula ekranÄ±nda Geri DÃ¶n butonuna tÄ±kla (Web kontrolÃ¼ - CACHE YOK)
        OPTIMIZE: child_window() ile direkt arama (hÄ±zlÄ±), fallback ile gÃ¼venli

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            # OPTIMIZE: Ã–nce child_window() ile hÄ±zlÄ± arama
            try:
                geri_don_btn = self.main_window.child_window(
                    title_re=".*Geri D[Ã¶o]n.*",
                    control_type="Button"
                )
                if geri_don_btn.exists(timeout=0.5):
                    try:
                        geri_don_btn.invoke()
                    except Exception as e:
                        logger.debug(f"First attempt failed: {type(e).__name__}")
                        try:
                            geri_don_btn.click()
                        except Exception as e:
                            logger.debug(f"Geri dÃ¶n click() failed: {type(e).__name__}")
                            geri_don_btn.click_input()

                    logger.info("âœ“ Geri DÃ¶n tÄ±klandÄ± (hÄ±zlÄ±)")
                    self.timed_sleep("geri_don_butonu")
                    return True
            except Exception as e:
                logger.debug(f"Operation failed: {type(e).__name__}")

            # FALLBACK: Eski yÃ¶ntem (descendants) - daha yavaÅŸ ama gÃ¼venli
            buttons = self.main_window.descendants(control_type="Button")

            for btn in buttons:
                try:
                    btn_name = btn.window_text()
                    if "Geri DÃ¶n" in btn_name or "Geri Don" in btn_name:
                        try:
                            btn.invoke()
                        except Exception as e:
                            logger.debug(f"Second attempt failed: {type(e).__name__}")
                            try:
                                btn.click()
                            except Exception as e:
                                logger.debug(f"Button click() failed: {type(e).__name__}")
                                btn.click_input()

                        logger.info("âœ“ Geri DÃ¶n tÄ±klandÄ± (fallback)")
                        self.timed_sleep("geri_don_butonu")
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            logger.warning("âŒ Geri DÃ¶n bulunamadÄ±")
            return False

        except Exception as e:
            logger.error(f"Geri DÃ¶n butonuna tÄ±klama hatasÄ±: {e}")
            return False

    def sonra_butonuna_tikla(self):
        """
        SONRA > butonuna tÄ±klayarak bir sonraki reÃ§eteye geÃ§ (Web kontrolÃ¼ - CACHE YOK)
        OPTIMIZE: child_window() ile direkt arama (hÄ±zlÄ±), fallback ile gÃ¼venli

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            # OPTIMIZE: Ã–nce child_window() ile hÄ±zlÄ± arama
            try:
                sonra_btn = self.main_window.child_window(
                    title_re=".*Sonra.*>.*",
                    control_type="Button"
                )
                if sonra_btn.exists(timeout=0.5):
                    try:
                        sonra_btn.invoke()
                    except Exception as e:
                        logger.debug(f"First attempt failed: {type(e).__name__}")
                        try:
                            sonra_btn.click()
                        except Exception as e:
                            logger.debug(f"Sonra button click() failed: {type(e).__name__}")
                            sonra_btn.click_input()

                    logger.info("âœ“ SONRA > Sonraki reÃ§ete (hÄ±zlÄ±)")
                    self.timed_sleep("sonra_butonu")
                    return True
            except Exception as e:
                logger.debug(f"Operation failed: {type(e).__name__}")

            # FALLBACK: Eski yÃ¶ntem (descendants) - daha yavaÅŸ ama gÃ¼venli
            buttons = self.main_window.descendants(control_type="Button")

            for btn in buttons:
                try:
                    btn_name = btn.window_text()
                    if "Sonra" in btn_name and ">" in btn_name:
                        try:
                            btn.invoke()
                        except Exception as e:
                            logger.debug(f"Second attempt failed: {type(e).__name__}")
                            try:
                                btn.click()
                            except Exception as e:
                                logger.debug(f"Button click() failed: {type(e).__name__}")
                                btn.click_input()

                        logger.info("âœ“ SONRA > Sonraki reÃ§ete (fallback)")
                        self.timed_sleep("sonra_butonu")
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            logger.warning("âŒ SONRA yok (Son reÃ§ete)")
            return False

        except Exception as e:
            logger.error(f"SONRA butonuna tÄ±klama hatasÄ±: {e}")
            return False

    def recete_no_oku(self, max_deneme=5, bekleme_suresi=0.5):
        """
        Ekrandaki reÃ§ete numarasÄ±nÄ± oku (Ã¶rn: 3HKE0T4)
        Inspect'e gÃ¶re Window 0x1C0D14 ve Name Ã¶zelliÄŸinden alÄ±nÄ±r

        Args:
            max_deneme: Maksimum deneme sayÄ±sÄ± (varsayÄ±lan: 5)
            bekleme_suresi: Her deneme arasÄ±nda bekleme sÃ¼resi (varsayÄ±lan: 0.5 saniye)

        Returns:
            str: ReÃ§ete numarasÄ±, bulunamazsa None
        """
        import time

        for deneme in range(max_deneme):
            try:
                # Ã–nce spesifik window ID ile dene
                try:
                    # Text kontrollerini ara, Name Ã¶zelliÄŸi iÃ§inde reÃ§ete numarasÄ± olan
                    texts = self.main_window.descendants(control_type="Text")

                    for text in texts:
                        try:
                            # Name Ã¶zelliÄŸini al
                            name_prop = text.window_text()

                            # ReÃ§ete numarasÄ± formatÄ±: 6-8 karakter, alfanumerik
                            if name_prop and 6 <= len(name_prop) <= 9:
                                # Sadece harf, rakam iÃ§ermeli
                                if name_prop.replace('-', '').replace('_', '').isalnum():
                                    # En az 1 harf ve 1 rakam olmalÄ±
                                    if any(c.isdigit() for c in name_prop) and any(c.isalpha() for c in name_prop):
                                        logger.info(f"âœ“ ReÃ§ete No: {name_prop}")
                                        return name_prop
                        except Exception as e:
                            logger.debug(f"Operation failed: {type(e).__name__}")

                except Exception as e:
                    logger.debug(f"ID ile arama baÅŸarÄ±sÄ±z: {e}")

                # Alternatif: TÃ¼m text elementlerini tara
                texts = self.main_window.descendants(control_type="Text")

                for text in texts:
                    try:
                        text_value = text.window_text()
                        # ReÃ§ete numarasÄ± genellikle 7 karakterli alfanumerik kod (Ã¶rn: 3HKE0T4)
                        if text_value and 6 <= len(text_value) <= 9:
                            # Sadece harf, rakam ve belki tire iÃ§ermeli
                            cleaned = text_value.replace('-', '').replace('_', '')
                            if cleaned.isalnum() and any(c.isdigit() for c in text_value) and any(c.isalpha() for c in text_value):
                                logger.info(f"âœ“ ReÃ§ete No: {text_value}")
                                return text_value
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                # Bu denemede bulunamadÄ±, bir sonraki denemede tekrar dene
                if deneme < max_deneme - 1:
                    logger.debug(f"ReÃ§ete numarasÄ± henÃ¼z yÃ¼klenmedi, bekleniyor... ({deneme + 1}/{max_deneme})")
                    time.sleep(bekleme_suresi)

            except Exception as e:
                logger.debug(f"ReÃ§ete no okuma denemesi {deneme + 1} hatasÄ±: {e}")
                if deneme < max_deneme - 1:
                    time.sleep(bekleme_suresi)

        logger.warning("âš ï¸ ReÃ§ete numarasÄ± okunamadÄ±")
        return None

    def telefon_numarasi_kontrol(self):
        """
        ReÃ§etede telefon numarasÄ± var mÄ± kontrol et (4 farklÄ± alan)

        Kontrol edilen alanlar:
        1. lblMusteriTelefonu - MÃ¼ÅŸteri telefonu
        2. lblYanCariTelefonu - Yan cari telefonu
        3. lblIlaciAlanTelefonu - Ä°lacÄ± alan telefonu
        4. lblAlanYanCariTel - Alan yan cari telefonu

        Returns:
            bool: En az bir alanda telefon varsa True, hiÃ§birinde yoksa False
        """
        try:
            telefon_alanlari = [
                "lblMusteriTelefonu",
                "lblYanCariTelefonu",
                "lblIlaciAlanTelefonu",
                "lblAlanYanCariTel"
            ]

            logger.debug("ğŸ“ Telefon kontrolÃ¼ baÅŸlatÄ±lÄ±yor...")

            # SayfanÄ±n yÃ¼klenmesini bekle
            time.sleep(0.3)  # 0.5 â†’ 0.3 optimizasyon

            bulunan_telefon_sayisi = 0
            control_types = ["Text", "Edit", "Static"]  # FarklÄ± element tiplerini dene

            for alan_id in telefon_alanlari:
                telefon_text = ""
                bulunan_elem_tipi = None

                logger.debug(f"Alan kontrol: {alan_id}")

                try:
                    # FarklÄ± control type'larÄ± dene
                    for ctrl_type in control_types:
                        try:
                            telefon_elems = self.main_window.descendants(auto_id=alan_id, control_type=ctrl_type)
                            logger.debug(f"{ctrl_type}: {len(telefon_elems) if telefon_elems else 0} sonuÃ§")

                            if telefon_elems and len(telefon_elems) > 0:
                                telefon_elem = telefon_elems[0]
                                bulunan_elem_tipi = ctrl_type

                                # window_text() ile telefon numarasÄ±nÄ± al
                                try:
                                    raw_text = telefon_elem.window_text()
                                    telefon_text = raw_text.strip() if raw_text else ""
                                    logger.debug(f"window_text(): '{telefon_text}'")
                                except Exception as e1:
                                    logger.debug(f"window_text() hatasÄ±: {type(e1).__name__}")
                                    try:
                                        raw_name = telefon_elem.element_info.name
                                        telefon_text = raw_name.strip() if raw_name else ""
                                        logger.debug(f"element_info.name: '{telefon_text}'")
                                    except Exception as e2:
                                        logger.debug(f"element_info.name hatasÄ±: {type(e2).__name__}")
                                        telefon_text = ""

                                if telefon_text:  # Telefon bulundu, daha fazla type denemeye gerek yok
                                    logger.debug(f"DeÄŸer bulundu: {alan_id}")
                                    break
                        except Exception as e:
                            logger.debug(f"{ctrl_type} arama hatasÄ±: {type(e).__name__}")
                            continue

                    # Control type bulunamazsa, type kÄ±sÄ±tlamasÄ± olmadan dene
                    if not telefon_text:
                        logger.debug(f"Tip kÄ±sÄ±tlamasÄ± olmadan deneniyor...")
                        try:
                            telefon_elems = self.main_window.descendants(auto_id=alan_id)
                            logger.debug(f"Tip kÄ±sÄ±tlamasÄ±z: {len(telefon_elems) if telefon_elems else 0} sonuÃ§")

                            if telefon_elems and len(telefon_elems) > 0:
                                telefon_elem = telefon_elems[0]
                                bulunan_elem_tipi = "Typeless"

                                try:
                                    raw_text = telefon_elem.window_text()
                                    telefon_text = raw_text.strip() if raw_text else ""
                                    logger.debug(f"window_text(): '{telefon_text}'")
                                except Exception as e1:
                                    logger.debug(f"window_text() hatasÄ±: {type(e1).__name__}")
                                    try:
                                        raw_name = telefon_elem.element_info.name
                                        telefon_text = raw_name.strip() if raw_name else ""
                                        logger.debug(f"element_info.name: '{telefon_text}'")
                                    except Exception as e2:
                                        logger.debug(f"element_info.name hatasÄ±: {type(e2).__name__}")
                                        telefon_text = ""
                        except Exception as e:
                            logger.debug(f"Tip kÄ±sÄ±tlamasÄ±z arama hatasÄ±: {type(e).__name__}")

                    logger.debug(f"{alan_id}: '{telefon_text}' (len={len(telefon_text)}, tip={bulunan_elem_tipi})")

                    # Telefon varsa (boÅŸ deÄŸilse ve geÃ§erli uzunlukta)
                    # Telefon numaralarÄ± genellikle en az 7 karakter (bazÄ± formatlar iÃ§in)
                    if telefon_text and len(telefon_text) >= 7:
                        # Sadece rakam, boÅŸluk, tire, parantez iÃ§eriyorsa geÃ§erli telefon
                        temiz_telefon = telefon_text.replace(" ", "").replace("-", "").replace("(", "").replace(")", "")
                        logger.debug(f"TemizlenmiÅŸ: '{temiz_telefon}'")

                        if temiz_telefon and any(c.isdigit() for c in temiz_telefon):
                            bulunan_telefon_sayisi += 1
                            logger.info(f"âœ“ Telefon bulundu ({alan_id}): {telefon_text}")
                            return True  # EN AZ BÄ°R TELEFON VARSA HEMEN TRUE DÃ–N
                        else:
                            logger.debug(f"GeÃ§ersiz format (rakam yok)")
                    else:
                        logger.debug(f"BOÅ veya Ã§ok kÄ±sa")

                except Exception as e:
                    logger.debug(f"  âŒ {alan_id} kontrol hatasÄ±: {e}")
                    import traceback
                    traceback.print_exc()
                    continue

            # Auto_ID ile bulunamadÄ±ysa, alternatif: TÃ¼m text elementlerini tara
            if bulunan_telefon_sayisi == 0:
                logger.debug("Alternatif arama baÅŸlatÄ±lÄ±yor...")

                try:
                    import re
                    # TÃ¼rkiye telefon numarasÄ± pattern'i (Ã§eÅŸitli formatlar)
                    telefon_pattern = re.compile(r'(\+90|0)?[\s\-\(]?[1-9]\d{2}[\s\-\)]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}')

                    # TÃ¼m text elementlerini al
                    all_texts = self.main_window.descendants(control_type="Text")
                    logger.debug(f"Toplam {len(all_texts)} Text elementi bulundu")

                    # Ã–nce auto_id'li elementleri kontrol et
                    for text_elem in all_texts:
                        try:
                            auto_id = None
                            try:
                                auto_id = text_elem.element_info.automation_id
                            except Exception as e:
                                logger.debug(f"Operation failed: {type(e).__name__}")

                            if auto_id and "Tel" in auto_id:
                                try:
                                    raw_text = text_elem.window_text()
                                    text_value = raw_text.strip() if raw_text else ""
                                except Exception as e:
                                    logger.debug(f"Fourth attempt failed: {type(e).__name__}")
                                    try:
                                        raw_name = text_elem.element_info.name
                                        text_value = raw_name.strip() if raw_name else ""
                                    except Exception as e:
                                        logger.debug(f"Text value read failed: {type(e).__name__}")
                                        text_value = ""

                                logger.debug(f"Tel ID: {auto_id} = '{text_value}'")

                                if text_value and len(text_value) >= 7:
                                    # Pattern kontrolÃ¼
                                    if telefon_pattern.search(text_value) or any(c.isdigit() for c in text_value):
                                        logger.info(f"âœ“ Telefon bulundu (alt. arama): {text_value}")
                                        return True
                        except Exception as e:
                            logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                            continue

                    # Hala bulunamadÄ±ysa, tÃ¼m text deÄŸerlerini pattern ile kontrol et
                    logger.debug("Pattern tabanlÄ± arama yapÄ±lÄ±yor...")
                    for text_elem in all_texts[:100]:  # Ä°lk 100 elementi kontrol et (performans iÃ§in)
                        try:
                            try:
                                raw_text = text_elem.window_text()
                                text_value = raw_text.strip() if raw_text else ""
                            except Exception as e:
                                logger.debug(f"Third attempt failed: {type(e).__name__}")
                                try:
                                    raw_name = text_elem.element_info.name
                                    text_value = raw_name.strip() if raw_name else ""
                                except Exception as e:
                                    logger.debug(f"Text value read failed: {type(e).__name__}")
                                    text_value = ""

                            if text_value and telefon_pattern.search(text_value):
                                logger.info(f"âœ“ Telefon bulundu (pattern arama): {text_value}")
                                return True
                        except Exception as e:
                            logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                            continue

                except Exception as e:
                    logger.debug(f"Alternatif arama hatasÄ±: {e}")

            # HiÃ§bir alanda telefon yok
            logger.info(f"âš  Telefon bulunamadÄ± ({bulunan_telefon_sayisi}/4 alan dolu)")
            return False

        except Exception as e:
            logger.error(f"âŒ Telefon kontrolÃ¼ HATA: {e}")
            import traceback
            traceback.print_exc()
            # Hata durumunda telefon var kabul et (gÃ¼venli taraf)
            logger.warning(f"âš  HATA durumu: Telefon VAR kabul ediliyor (gÃ¼venli taraf)")
            return True

    def recete_kaydi_var_mi_kontrol(self):
        """
        Ekranda "ReÃ§ete kaydÄ± bulunamadÄ±" veya "Sistem hatasÄ±" uyarÄ±sÄ± var mÄ± kontrol et

        Returns:
            bool: ReÃ§ete kaydÄ± VARSA True, YOKSA (uyarÄ± varsa) False
        """
        try:
            # TÃ¼m text elementlerini ara
            texts = self.main_window.descendants(control_type="Text")

            for text in texts:
                try:
                    text_value = text.window_text()
                    # "ReÃ§ete kaydÄ± bulunamadÄ±" kontrolÃ¼
                    if "ReÃ§ete kaydÄ± bulunamadÄ±" in text_value or "Recete kaydÄ± bulunamadÄ±" in text_value:
                        logger.warning(f"âš ï¸ '{text_value}'")
                        return False
                    # "Sistem hatasÄ±" kontrolÃ¼
                    if "Sistem hatasÄ±" in text_value or "Sistem hatasi" in text_value:
                        logger.error(f"âŒ MEDULA HATA: '{text_value}'")
                        return False
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            return True

        except Exception as e:
            logger.error(f"Kontrol hatasÄ±: {e}")
            # Hata durumunda gÃ¼venli tarafta kalalÄ±m ve devam edelim
            return True

    def recete_sorgu_ac(self):
        """
        ReÃ§ete Sorgu butonuna tÄ±kla (CACHE destekli)

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.debug("ReÃ§ete Sorgu butonu aranÄ±yor...")

            # Ã–nce cache'den kontrol et
            cached_button = self._get_cached_element("recete_sorgu_button")
            if cached_button:
                try:
                    cached_button.invoke()
                    logger.info("âœ“ ReÃ§ete Sorgu butonu tÄ±klandÄ± (cache)")
                    self.timed_sleep("recete_sorgu")
                    return True
                except Exception as e:
                    logger.debug(f"Cache recete_sorgu_button invoke failed: {type(e).__name__}")
                    self._clear_cache_key("recete_sorgu_button")

            # YÃ¶ntem 1: AutomationId ile ara (OPTIMIZE: control_type eklendi)
            try:
                sorgu_button = self.main_window.descendants(auto_id="form1:menuHtmlCommandExButton51_MOUSE", control_type="Button")
                if sorgu_button and len(sorgu_button) > 0:
                    self._cache_element("recete_sorgu_button", sorgu_button[0])  # Cache'e ekle
                    try:
                        sorgu_button[0].invoke()
                    except Exception as e:
                        logger.debug(f"First attempt failed: {type(e).__name__}")
                        try:
                            sorgu_button[0].click()
                        except Exception as e:
                            logger.debug(f"Sorgu button click() failed: {type(e).__name__}")
                            sorgu_button[0].click_input()

                    logger.info("âœ“ ReÃ§ete Sorgu butonu tÄ±klandÄ± (AutomationId)")
                    self.timed_sleep("recete_sorgu")
                    return True
            except Exception as e:
                logger.debug(f"AutomationId ile bulunamadÄ±: {e}")

            # YÃ¶ntem 2: Name ile ara (Control Type 50000)
            try:
                buttons = self.main_window.descendants(control_type="Button")
                for btn in buttons:
                    try:
                        btn_name = btn.window_text()
                        # TAM EÅLEÅÄ°K kontrolÃ¼ - "e-ReÃ§ete Sorgu" gibi yanlÄ±ÅŸ butonlarÄ± atla
                        if btn_name:
                            btn_name_stripped = btn_name.strip()
                            # Sadece "ReÃ§ete Sorgu" veya "Recete Sorgu" olanlarÄ± al
                            # "e-ReÃ§ete Sorgu", "E-ReÃ§ete Sorgu" vb. HARÄ°Ã‡
                            if btn_name_stripped == "ReÃ§ete Sorgu" or btn_name_stripped == "Recete Sorgu":
                                self._cache_element("recete_sorgu_button", btn)  # Cache'e ekle
                                try:
                                    btn.invoke()
                                except Exception as e:
                                    logger.debug(f"Fourth attempt failed: {type(e).__name__}")
                                    try:
                                        btn.click()
                                    except Exception as e:
                                        logger.debug(f"Button click() failed: {type(e).__name__}")
                                        btn.click_input()

                                logger.info("âœ“ ReÃ§ete Sorgu butonu tÄ±klandÄ± (Name)")
                                self.timed_sleep("recete_sorgu")
                                return True
                    except Exception as e:
                        logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                        continue
            except Exception as e:
                logger.debug(f"Name ile bulunamadÄ±: {e}")

            # YÃ¶ntem 3: TÃ¼m kontrolleri tara
            try:
                all_controls = self.main_window.descendants()
                for ctrl in all_controls:
                    try:
                        ctrl_name = ctrl.window_text()
                        # TAM EÅLEÅÄ°K kontrolÃ¼ - "e-ReÃ§ete Sorgu" gibi yanlÄ±ÅŸ butonlarÄ± atla
                        if ctrl_name:
                            ctrl_name_stripped = ctrl_name.strip()
                            # Sadece "ReÃ§ete Sorgu" veya "Recete Sorgu" olanlarÄ± al
                            if ctrl_name_stripped == "ReÃ§ete Sorgu" or ctrl_name_stripped == "Recete Sorgu":
                                self._cache_element("recete_sorgu_button", ctrl)  # Cache'e ekle
                                try:
                                    ctrl.invoke()
                                except Exception as e:
                                    logger.debug(f"Fourth attempt failed: {type(e).__name__}")
                                    try:
                                        ctrl.click()
                                    except Exception as e:
                                        logger.debug(f"Control click() failed: {type(e).__name__}")
                                        ctrl.click_input()

                                logger.info("âœ“ ReÃ§ete Sorgu butonu tÄ±klandÄ± (TÃ¼m kontroller)")
                                self.timed_sleep("recete_sorgu")
                                return True
                    except Exception as e:
                        logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                        continue
            except Exception as e:
                logger.debug(f"TÃ¼m kontroller ile bulunamadÄ±: {e}")

            logger.error("âŒ ReÃ§ete Sorgu butonu bulunamadÄ± (tÃ¼m yÃ¶ntemler denendi)")
            return False

        except Exception as e:
            logger.error(f"ReÃ§ete Sorgu butonu hatasÄ±: {e}")
            return False

    def ana_sayfaya_don(self):
        """
        Ana Sayfa butonuna tÄ±kla (ReÃ§ete iÃ§indeyken sol menÃ¼ Ã§Ä±kmasÄ± iÃ§in) (CACHE destekli)

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.debug("Ana Sayfa butonu aranÄ±yor...")

            # Ã–nce cache'den kontrol et
            cached_button = self._get_cached_element("ana_sayfa_button")
            if cached_button:
                try:
                    cached_button.invoke()
                    logger.info("âœ“ Ana Sayfa butonu tÄ±klandÄ± (cache)")
                    self.timed_sleep("ana_sayfa")
                    return True
                except Exception as e:
                    logger.debug(f"Cache ana_sayfa_button invoke failed: {type(e).__name__}")
                    self._clear_cache_key("ana_sayfa_button")

            # YÃ¶ntem 1: AutomationId ile ara (OPTIMIZE: control_type eklendi, f: Ã¶neki eklendi)
            try:
                ana_sayfa_button = self.main_window.descendants(auto_id="f:buttonAnaSayfa", control_type="Button")
                if ana_sayfa_button and len(ana_sayfa_button) > 0:
                    self._cache_element("ana_sayfa_button", ana_sayfa_button[0])  # Cache'e ekle
                    try:
                        ana_sayfa_button[0].invoke()
                    except Exception as e:
                        logger.debug(f"First attempt failed: {type(e).__name__}")
                        try:
                            ana_sayfa_button[0].click()
                        except Exception as e:
                            logger.debug(f"Ana sayfa button click() failed: {type(e).__name__}")
                            ana_sayfa_button[0].click_input()

                    logger.info("âœ“ Ana Sayfa butonu tÄ±klandÄ± (AutomationId)")
                    self.timed_sleep("ana_sayfa")
                    return True
            except Exception as e:
                logger.debug(f"AutomationId ile bulunamadÄ±: {e}")

            # YÃ¶ntem 2: Name ile ara
            try:
                buttons = self.main_window.descendants(control_type="Button")
                for btn in buttons:
                    try:
                        btn_name = btn.window_text()
                        if btn_name and btn_name.strip() == "Ana Sayfa":
                            self._cache_element("ana_sayfa_button", btn)  # Cache'e ekle
                            try:
                                btn.invoke()
                            except Exception as e:
                                logger.debug(f"Third attempt failed: {type(e).__name__}")
                                try:
                                    btn.click()
                                except Exception as e2:
                                    logger.debug(f"Fourth attempt failed: {type(e2).__name__}")
                                    btn.click_input()

                            logger.info("âœ“ Ana Sayfa butonu tÄ±klandÄ± (Name)")
                            self.timed_sleep("ana_sayfa")
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                        continue
            except Exception as e:
                logger.debug(f"Name ile bulunamadÄ±: {e}")

            logger.error("âŒ Ana Sayfa butonu bulunamadÄ±")
            return False

        except Exception as e:
            logger.error(f"Ana Sayfa butonu hatasÄ±: {e}")
            return False

    def recete_no_yaz(self, recete_no):
        """
        ReÃ§ete numarasÄ±nÄ± giriÅŸ alanÄ±na yaz

        Args:
            recete_no (str): YazÄ±lacak reÃ§ete numarasÄ±

        Returns:
            bool: Yazma baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.info(f"ReÃ§ete numarasÄ± yazÄ±lÄ±yor: {recete_no}")

            # YÃ¶ntem 1: AutomationId ile spesifik alanÄ± bul (form1:text2) (OPTIMIZE: control_type eklendi)
            try:
                recete_no_field = self.main_window.descendants(auto_id="form1:text2", control_type="Edit")
                if recete_no_field and len(recete_no_field) > 0:
                    edit = recete_no_field[0]

                    # Focus'u al
                    edit.set_focus()
                    self.timed_sleep("text_focus")

                    # Ã–nce temizle
                    try:
                        edit.set_edit_text("")
                        self.timed_sleep("text_clear")
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                    # Yeni deÄŸeri yaz
                    edit.set_edit_text(recete_no)
                    self.timed_sleep("text_write")

                    # Kontrol et
                    try:
                        current_value = edit.get_value()
                        if current_value == recete_no:
                            logger.info(f"âœ“ ReÃ§ete numarasÄ± yazÄ±ldÄ± (AutomationId): {recete_no}")
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                    # Alternatif kontrol
                    try:
                        current_text = edit.window_text()
                        if current_text == recete_no:
                            logger.info(f"âœ“ ReÃ§ete numarasÄ± yazÄ±ldÄ± (AutomationId): {recete_no}")
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                    # Yazma iÅŸlemi yapÄ±ldÄ± ama doÄŸrulama yapÄ±lamadÄ±
                    logger.info(f"âœ“ ReÃ§ete numarasÄ± yazÄ±ldÄ± (AutomationId, doÄŸrulama yok): {recete_no}")
                    return True

            except Exception as e:
                logger.debug(f"AutomationId ile yazÄ±lamadÄ±: {e}")

            # YÃ¶ntem 2: Control Type 50004 (Edit control) - Ä°LK BOÅ edit alanÄ±nÄ± bul
            try:
                edit_controls = self.main_window.descendants(control_type="Edit")

                # Ä°lk BOÅ edit alanÄ±nÄ± bul (TC kimlik dolu, reÃ§ete numarasÄ± boÅŸ)
                for i, edit in enumerate(edit_controls):
                    try:
                        # Mevcut deÄŸeri kontrol et
                        current_value = ""
                        try:
                            current_value = edit.get_value() or ""
                        except Exception as e:
                            logger.debug(f"Second attempt failed: {type(e).__name__}")
                            try:
                                current_value = edit.window_text() or ""
                            except Exception as e:
                                logger.debug(f"Operation failed: {type(e).__name__}")

                        # BOÅ deÄŸilse atla
                        if current_value.strip():
                            continue

                        # BoÅŸ bulundu, buraya yaz
                        edit.set_focus()
                        self.timed_sleep("text_focus")

                        # Temizle
                        edit.set_edit_text("")
                        self.timed_sleep("text_clear")

                        # Yeni deÄŸeri yaz
                        edit.set_edit_text(recete_no)
                        self.timed_sleep("text_write")

                        # Kontrol et
                        try:
                            current_value = edit.get_value()
                        except Exception as e:
                            logger.debug(f"Second attempt failed: {type(e).__name__}")
                            try:
                                current_value = edit.window_text()
                            except Exception as e:
                                logger.debug(f"Operation failed: {type(e).__name__}")

                        if current_value == recete_no:
                            logger.info(f"âœ“ ReÃ§ete numarasÄ± yazÄ±ldÄ± (Ä°lk boÅŸ Edit): {recete_no}")
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                        continue

                logger.error("âŒ ReÃ§ete numarasÄ± alanÄ± bulunamadÄ±")
                return False

            except Exception as e:
                logger.error(f"Edit kontrol hatasÄ±: {e}")
                return False

        except Exception as e:
            logger.error(f"ReÃ§ete numarasÄ± yazma hatasÄ±: {e}")
            return False

    def sorgula_butonuna_tikla(self):
        """
        Sorgula butonuna tÄ±kla (ÃœSTTEKÄ° ReÃ§ete NumarasÄ± yanÄ±ndaki) (CACHE destekli)

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.debug("Sorgula butonu aranÄ±yor...")

            # Ã–nce cache'den kontrol et
            cached_button = self._get_cached_element("sorgula_button")
            if cached_button:
                try:
                    cached_button.invoke()
                    logger.info("âœ“ Sorgula butonu tÄ±klandÄ± (cache)")
                    self.timed_sleep("sorgula_butonu")
                    return True
                except Exception as e:
                    logger.debug(f"Cache sorgula_button invoke failed: {type(e).__name__}")
                    self._clear_cache_key("sorgula_button")

            # YÃ¶ntem 1: AutomationId ile ara (EN DOÄRUSU) (OPTIMIZE: control_type eklendi)
            try:
                sorgula_button = self.main_window.descendants(auto_id="form1:buttonReceteNoSorgula", control_type="Button")
                if sorgula_button and len(sorgula_button) > 0:
                    self._cache_element("sorgula_button", sorgula_button[0])  # Cache'e ekle
                    try:
                        sorgula_button[0].invoke()
                    except Exception as e:
                        logger.debug(f"First attempt failed: {type(e).__name__}")
                        try:
                            sorgula_button[0].click()
                        except Exception as e:
                            logger.debug(f"Sorgula button click() failed: {type(e).__name__}")
                            sorgula_button[0].click_input()

                    logger.info("âœ“ Sorgula butonu tÄ±klandÄ± (AutomationId)")
                    self.timed_sleep("sorgula_butonu")
                    return True
            except Exception as e:
                logger.debug(f"AutomationId ile bulunamadÄ±: {e}")

            # YÃ¶ntem 2: Name="Sorgula" + Ä°LK buton (en Ã¼stteki)
            try:
                buttons = self.main_window.descendants(control_type="Button")
                for btn in buttons:
                    try:
                        btn_name = btn.window_text()
                        if btn_name and btn_name.strip() == "Sorgula":
                            self._cache_element("sorgula_button", btn)  # Cache'e ekle
                            # Ä°LK "Sorgula" butonunu bul (en Ã¼stteki)
                            try:
                                btn.invoke()
                            except Exception as e:
                                logger.debug(f"Third attempt failed: {type(e).__name__}")
                                try:
                                    btn.click()
                                except Exception as e2:
                                    logger.debug(f"Fourth attempt failed: {type(e2).__name__}")
                                    btn.click_input()

                            logger.info("âœ“ Sorgula butonu tÄ±klandÄ± (Ä°lk Sorgula)")
                            self.timed_sleep("sorgula_butonu")
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed, continuing: {type(e).__name__}")
                        continue
            except Exception as e:
                logger.debug(f"Name ile bulunamadÄ±: {e}")

            logger.error("âŒ Sorgula butonu bulunamadÄ± (tÃ¼m yÃ¶ntemler denendi)")
            return False

        except Exception as e:
            logger.error(f"Sorgula butonu hatasÄ±: {e}")
            return False

    def recete_bilgilerini_al(self):
        """
        Ekrandaki reÃ§ete bilgilerini al

        âš ï¸ NOT IMPLEMENTED YET
        Bu fonksiyon henÃ¼z tamamlanmamÄ±ÅŸtÄ±r.

        Returns:
            None: Fonksiyon implement edilmediÄŸi iÃ§in her zaman None dÃ¶ner
        """
        logger.warning("âš ï¸ recete_bilgilerini_al() henÃ¼z implement edilmedi")
        # TODO: ReÃ§ete bilgilerini okuma iÅŸlemi implement edilecek
        return None

    def rapor_butonuna_tikla(self):
        """
        Rapor butonuna tÄ±kla (AutomationId: f:buttonRaporListesi)

        Returns:
            bool: TÄ±klama baÅŸarÄ±lÄ± ise True
        """
        try:
            logger.info("ğŸ” Rapor butonu aranÄ±yor...")

            # Ã–nce AutomationId ile hÄ±zlÄ± arama (birden fazla varyasyonu dene)
            automation_ids = [
                "f:buttonRaporListesi",
                "buttonRaporListesi",
                "btnRaporListesi",
                "btnRapor",
                "f:btnRaporListesi"
            ]

            for auto_id in automation_ids:
                try:
                    logger.debug(f"  YÃ¶ntem 1: AutomationId ile aranÄ±yor ({auto_id})...")
                    rapor_btn = self.main_window.child_window(
                        auto_id=auto_id,
                        control_type="Button"
                    )
                    if rapor_btn.exists(timeout=0.2):
                        logger.info(f"  âœ“ Rapor butonu bulundu (AutomationId: {auto_id})")
                        try:
                            rapor_btn.invoke()
                        except Exception as e:
                            logger.debug(f"  invoke() hatasÄ±: {type(e).__name__}")
                            try:
                                rapor_btn.click()
                            except Exception as e:
                                logger.debug(f"  click() hatasÄ±: {type(e).__name__}")
                                rapor_btn.click_input()

                        logger.info("âœ… Rapor butonu tÄ±klandÄ± (AutomationId)")
                        self.timed_sleep("rapor_button_wait", 0.5)
                        return True
                except Exception as e:
                    logger.debug(f"  {auto_id} arama hatasÄ±: {type(e).__name__}")

            logger.warning("  âœ— Rapor butonu bulunamadÄ± (tÃ¼m AutomationId'ler)")

            # FALLBACK: Ä°simle arama (daha fazla varyasyon)
            logger.debug("  YÃ¶ntem 2: Ä°simle aranÄ±yor...")
            buttons = self.main_window.descendants(control_type="Button")
            logger.info(f"  Toplam {len(buttons)} buton bulundu, taranÄ±yor...")

            # FarklÄ± isim varyasyonlarÄ±
            rapor_isimleri = ["Rapor", "Rapor Listesi", "RaporListesi", "Raporlar"]

            for btn in buttons:
                try:
                    btn_name = btn.window_text().strip()

                    # Tam eÅŸleÅŸme kontrolÃ¼
                    if btn_name in rapor_isimleri:
                        logger.info(f"  âœ“ Rapor butonu bulundu (Name: {btn_name})")
                        try:
                            btn.invoke()
                        except Exception as e:
                            logger.debug(f"  invoke() hatasÄ±: {type(e).__name__}")
                            try:
                                btn.click()
                            except Exception as e:
                                logger.debug(f"  click() hatasÄ±: {type(e).__name__}")
                                btn.click_input()

                        logger.info("âœ… Rapor butonu tÄ±klandÄ± (Name)")
                        self.timed_sleep("rapor_button_wait", 0.5)
                        return True

                    # KÄ±smi eÅŸleÅŸme kontrolÃ¼
                    elif "Rapor" in btn_name and "Listesi" in btn_name:
                        logger.info(f"  âœ“ Rapor butonu bulundu (kÄ±smi eÅŸleÅŸme: {btn_name})")
                        try:
                            btn.invoke()
                        except Exception as e:
                            logger.debug(f"  invoke() hatasÄ±: {type(e).__name__}")
                            try:
                                btn.click()
                            except Exception as e:
                                logger.debug(f"  click() hatasÄ±: {type(e).__name__}")
                                btn.click_input()

                        logger.info("âœ… Rapor butonu tÄ±klandÄ± (kÄ±smi eÅŸleÅŸme)")
                        self.timed_sleep("rapor_button_wait", 0.5)
                        return True

                except Exception as e:
                    logger.debug(f"  Buton kontrol hatasÄ±: {type(e).__name__}")

            # Hata durumunda daha fazla debug bilgi ver
            logger.error("âŒ Rapor butonu bulunamadÄ± (tÃ¼m yÃ¶ntemler denendi)")
            buton_isimleri = []
            for b in buttons[:30]:
                try:
                    isim = b.window_text().strip()
                    if isim:
                        buton_isimleri.append(isim)
                except:
                    pass
            logger.info(f"  Bulunan ilk 30 buton ismi: {buton_isimleri}")

            # AutomationId'leri de logla
            buton_auto_ids = []
            for b in buttons[:30]:
                try:
                    auto_id = b.automation_id()
                    if auto_id:
                        buton_auto_ids.append(auto_id)
                except:
                    pass
            logger.info(f"  Bulunan ilk 30 buton AutomationId: {buton_auto_ids}")

            return False

        except Exception as e:
            logger.error(f"âŒ Rapor butonuna tÄ±klama hatasÄ±: {e}", exc_info=True)
            return False

    def rapor_listesini_topla(self):
        """
        Rapor listesi penceresini aÃ§ar ve hasta rapor bilgilerini toplar.

        Tablo yapÄ±sÄ± (HTML'den):
        - Hak Sahibi Bilgileri: TC, Ad/Soyad, Cinsiyet, DoÄŸum Tarihi
        - Raporlar tablosu: Rapor Takip No | Rapor No | BaÅŸlangÄ±Ã§ | BitiÅŸ | KayÄ±t Åekli | TanÄ±

        Returns:
            dict: {
                'ad_soyad': str,
                'telefon': str,
                'raporlar': [{'tani': str, 'bitis_tarihi': str}, ...]
            }
            None: Veri toplanamadÄ±ysa
        """
        try:
            # Rapor butonuna tÄ±kla
            logger.info("ğŸ”µ Rapor butonuna tÄ±klanÄ±yor...")
            if not self.rapor_butonuna_tikla():
                logger.warning("âš ï¸ Rapor butonuna tÄ±klanamadÄ±")
                return None

            logger.info("âœ“ Rapor butonuna tÄ±klandÄ±")

            # Rapor listesi penceresinin aÃ§Ä±lmasÄ±nÄ± bekle
            self.timed_sleep("rapor_pencere_acilis", 1.5)

            # Telefon numarasÄ±nÄ± ana pencereden al
            telefon = self.telefon_numarasi_oku()
            logger.info(f"ğŸ“ Telefon: {telefon}")

            # Hasta adÄ±nÄ± "Hak Sahibi Bilgileri" bÃ¶lÃ¼mÃ¼nden al
            ad_soyad = self._hak_sahibi_adini_oku()
            logger.info(f"ğŸ‘¤ Hasta adÄ±: {ad_soyad}")

            # Rapor tablosunu bul ve verileri topla
            raporlar = []
            try:
                # DataGrid veya Table kontrolÃ¼nÃ¼ ana pencerede ara
                tables = self.main_window.descendants(control_type="DataGrid")
                if not tables:
                    tables = self.main_window.descendants(control_type="Table")

                logger.info(f"ğŸ” Bulunan tablo sayÄ±sÄ±: {len(tables)}")

                for table_idx, table in enumerate(tables):
                    try:
                        # Tablo satÄ±rlarÄ±nÄ± oku (DataItem)
                        rows = table.descendants(control_type="DataItem")
                        logger.info(f"  ğŸ“Š Tablo {table_idx+1}: {len(rows)} satÄ±r")

                        ilk_tablo_rapor_sayisi = 0

                        for row_idx, row in enumerate(rows):
                            try:
                                # Her satÄ±rdaki hÃ¼creleri oku
                                cells = row.descendants(control_type="Text")
                                cell_values = [c.window_text().strip() for c in cells if c.window_text().strip()]

                                # DEBUG: Ä°lk tablonun ilk 3 satÄ±rÄ±nÄ± logla
                                if table_idx == 0 and row_idx < 3:
                                    logger.info(f"    ğŸ” SatÄ±r {row_idx+1}: {cell_values}")

                                # Rapor satÄ±rÄ±nÄ± parse et
                                # Tablo yapÄ±sÄ±: [RaporTakipNo, RaporNo, BaÅŸlangÄ±Ã§, BitiÅŸ, KayÄ±tÅekli, TanÄ±]
                                rapor = self._parse_rapor_satiri(cell_values)
                                if rapor:
                                    raporlar.append(rapor)
                                    ilk_tablo_rapor_sayisi += 1
                                    logger.info(f"  âœ“ Rapor {len(raporlar)}: {rapor['tani'][:50]}... | {rapor['bitis_tarihi']}")

                            except Exception as row_err:
                                logger.debug(f"SatÄ±r okuma hatasÄ±: {row_err}")

                        # Optimizasyon: Ä°lk tabloda rapor bulunduysa diÄŸer tablolarÄ± tarama
                        if ilk_tablo_rapor_sayisi > 0:
                            logger.info(f"  âš¡ {ilk_tablo_rapor_sayisi} rapor bulundu")
                            break

                    except Exception as table_err:
                        logger.debug(f"Tablo okuma hatasÄ±: {table_err}")

            except Exception as e:
                logger.error(f"Rapor tablosu okuma hatasÄ±: {e}")

            # Rapor penceresini kapat (ESC)
            try:
                send_keys("{ESC}")
                self.timed_sleep("pencere_kapatma", 0.3)
                logger.info("âœ“ Rapor penceresi kapatÄ±ldÄ±")
            except Exception as e:
                logger.debug(f"Pencere kapatma hatasÄ±: {e}")

            # Veri dÃ¶ndÃ¼r
            if raporlar:
                logger.info(f"âœ… Toplam {len(raporlar)} rapor toplandÄ± - Hasta: {ad_soyad}")
                return {
                    'ad_soyad': ad_soyad,
                    'telefon': telefon,
                    'raporlar': raporlar
                }
            else:
                logger.warning(f"âš ï¸ HiÃ§ rapor verisi toplanamadÄ± - Hasta: {ad_soyad}, Telefon: {telefon}")
                logger.warning(f"   Tablo sayÄ±sÄ±: {len(tables) if 'tables' in locals() else 'bilinmiyor'}")
                return None

        except Exception as e:
            logger.error(f"âŒ Rapor toplama hatasÄ±: {e}", exc_info=True)
            try:
                send_keys("{ESC}")
                self.timed_sleep("pencere_kapatma", 0.3)
            except Exception as esc_err:
                logger.debug(f"ESC kapatma hatasÄ±: {esc_err}")
            return None

    def _hak_sahibi_adini_oku(self):
        """Hak Sahibi Bilgileri bÃ¶lÃ¼mÃ¼nden hasta adÄ±nÄ± okur."""
        try:
            # TÃ¼m Text elemanlarÄ±nÄ± tara
            all_texts = self.main_window.descendants(control_type="Text")

            # Ad ve soyad iÃ§in aday deÄŸerleri topla
            ad_aday = None
            soyad_aday = None

            for i, elem in enumerate(all_texts):
                try:
                    text = elem.window_text().strip()

                    # "AdÄ± / SoyadÄ±" label'Ä±ndan sonraki deÄŸerleri ara
                    if "AdÄ±" in text and "SoyadÄ±" in text:
                        # Sonraki 2-3 Text elemanÄ± ad ve soyad olabilir
                        for j in range(1, 5):
                            if i + j < len(all_texts):
                                next_text = all_texts[i + j].window_text().strip()
                                # BoÅŸ deÄŸil, ":" deÄŸil, ve kÄ±sa bir kelime ise
                                if next_text and next_text != ":" and len(next_text) < 30:
                                    # SayÄ± veya Ã¶zel karakter iÃ§ermiyorsa
                                    if next_text.replace(" ", "").isalpha():
                                        if not ad_aday:
                                            ad_aday = next_text
                                        elif not soyad_aday:
                                            soyad_aday = next_text
                                            break
                        if ad_aday and soyad_aday:
                            break
                except Exception:
                    continue

            if ad_aday and soyad_aday:
                ad_soyad = f"{ad_aday} {soyad_aday}"
                logger.info(f"ğŸ“ Hasta adÄ± bulundu: {ad_soyad}")
                return ad_soyad

            logger.debug("Hasta adÄ± bulunamadÄ±, 'Bilinmeyen' kullanÄ±lacak")
            return "Bilinmeyen"

        except Exception as e:
            logger.debug(f"Hak sahibi adÄ± okuma hatasÄ±: {e}")
            return "Bilinmeyen"

    def _parse_rapor_satiri(self, cell_values):
        """
        Rapor tablosu satÄ±rÄ±nÄ± parse eder.

        Beklenen yapÄ±: [RaporTakipNo, RaporNo, BaÅŸlangÄ±Ã§Tarihi, BitiÅŸTarihi, KayÄ±tÅekli, TanÄ±]
        """
        if not cell_values or len(cell_values) < 3:
            return None

        # GeÃ§ersiz satÄ±rlarÄ± filtrele (uyarÄ± mesajlarÄ±, header vs.)
        text_combined = " ".join(cell_values)
        invalid_patterns = [
            "Hak sahibi bilgileri", "gÃ¼ncel deÄŸil", "SGK Sosyal", "MÃ¼stehaklÄ±k",
            "T.C. Kimlik", "Cinsiyeti", "Rapor Takip No", "BaÅŸlangÄ±Ã§ Tarihi",
            "BitiÅŸ Tarihi", "KayÄ±t Åekli", "AdÄ± / SoyadÄ±", "baÅŸvurunuz"
        ]
        if any(pattern in text_combined for pattern in invalid_patterns):
            return None

        # GeÃ§erli rapor tarihlerini bul (2020 ve sonrasÄ±)
        tarihler = []
        tarih_indexler = []
        for idx, val in enumerate(cell_values):
            if self._is_tarih(val):
                yil = int(val.split("/")[2])
                if yil >= 2020:
                    tarihler.append(val)
                    tarih_indexler.append(idx)

        if not tarihler:
            return None

        # DEBUG: Tarih bulunan satÄ±rlarÄ± logla
        logger.info(f"    ğŸ“… Tarihli satÄ±r: {cell_values[:4]}...")

        # BitiÅŸ tarihi: Ä°kinci tarih (veya tek varsa o)
        if len(tarihler) >= 2:
            bitis_tarihi = tarihler[1]
            son_tarih_idx = tarih_indexler[1]
        else:
            bitis_tarihi = tarihler[0]
            son_tarih_idx = tarih_indexler[0]

        # TanÄ±: ICD kodu pattern'ine uyan ilk deÄŸeri bul
        # Veya uzun metin (hastalÄ±k aÃ§Ä±klamasÄ±) olabilir
        tani = None
        for val in cell_values:
            # ICD pattern: "XX.XX - HastalÄ±k" veya "XX.XX.X - HastalÄ±k"
            if " - " in val and len(val) > 10:
                # Ä°lk kÄ±sÄ±m sayÄ±/nokta iÃ§ermeli
                first_part = val.split(" - ")[0].strip()
                if any(c.isdigit() for c in first_part[:5]):
                    # Elektronik Rapor deÄŸilse tanÄ± olarak al
                    if "Elektronik" not in val and "Ä°mzalÄ±" not in val:
                        tani = val
                        break

        # EÄŸer ICD formatÄ±nda bulamadÄ±ysak, en uzun metni tanÄ± olarak al
        if not tani:
            for val in cell_values:
                # Tarih deÄŸilse ve uzunsa tanÄ± olabilir
                if not self._is_tarih(val) and len(val) > 15 and not val.isdigit():
                    if "Elektronik" not in val and "Ä°mzalÄ±" not in val:
                        tani = val
                        break

        if not tani:
            logger.debug(f"    âŒ TanÄ± bulunamadÄ±: {cell_values}")
            return None

        return {
            'tani': tani,
            'bitis_tarihi': bitis_tarihi
        }

    def _is_tarih(self, val):
        """DeÄŸerin DD/MM/YYYY formatÄ±nda tarih olup olmadÄ±ÄŸÄ±nÄ± kontrol eder."""
        if not val or "/" not in val:
            return False
        parts = val.split("/")
        if len(parts) != 3:
            return False
        try:
            gun, ay, yil = parts
            return (len(gun) == 2 and len(ay) == 2 and len(yil) == 4 and
                    gun.isdigit() and ay.isdigit() and yil.isdigit())
        except Exception:
            return False

    def hasta_ad_soyad_oku(self):
        """Ana pencereden hasta ad soyad okur"""
        try:
            texts = self.main_window.descendants(control_type="Text")
            for text in texts:
                try:
                    text_value = text.window_text()
                    if text_value and len(text_value.split()) >= 2 and len(text_value) > 5:
                        return text_value.strip()
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")
        except Exception as e:
            logger.debug(f"Operation failed: {type(e).__name__}")
        return "Bilinmeyen"

    def telefon_numarasi_oku(self):
        """Ana pencereden telefon numarasÄ± okur"""
        try:
            # Ã–nce lblMusteriTelefonu alanÄ±nÄ± kontrol et (en gÃ¼venilir)
            texts = self.main_window.descendants(control_type="Text")
            for text in texts:
                try:
                    auto_id = text.automation_id() if hasattr(text, 'automation_id') else None
                    if auto_id and 'Telefon' in auto_id:
                        text_value = text.window_text()
                        if text_value:
                            # "C:(544) 611 1522" gibi formatlarÄ± temizle
                            clean_phone = text_value.replace(" ", "").replace("-", "").replace("(", "").replace(")", "").replace("C:", "").replace("c:", "")
                            if clean_phone.isdigit() and len(clean_phone) >= 10:
                                logger.debug(f"Telefon bulundu (auto_id): {auto_id} = {clean_phone}")
                                return clean_phone
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            # Alternatif: Edit kontrollerinden ara
            edits = self.main_window.descendants(control_type="Edit")
            for edit in edits:
                try:
                    edit_value = edit.window_text()
                    if edit_value:
                        clean_phone = edit_value.replace(" ", "").replace("-", "").replace("(", "").replace(")", "").replace("C:", "").replace("c:", "")
                        if clean_phone.isdigit() and len(clean_phone) >= 10:
                            logger.debug(f"Telefon bulundu (Edit): {clean_phone}")
                            return clean_phone
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")
        except Exception as e:
            logger.debug(f"Operation failed: {type(e).__name__}")
        return ""

    def tum_butonlari_listele(self):
        """Debug iÃ§in penceredeki tÃ¼m butonlarÄ± listele"""
        try:
            logger.info("Penceredeki tÃ¼m butonlar listeleniyor...")
            buttons = self.main_window.descendants(control_type="Button")

            if buttons and len(buttons) > 0:
                logger.info(f"Toplam {len(buttons)} buton bulundu:")
                for i, btn in enumerate(buttons, 1):
                    try:
                        btn_name = btn.window_text()
                        if btn_name:
                            logger.info(f"  {i}. Buton: '{btn_name}'")
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")
            else:
                logger.warning("HiÃ§ buton bulunamadÄ±")
        except Exception as e:
            logger.error(f"Buton listeleme hatasÄ±: {e}")

    def pencere_bilgilerini_goster(self):
        """Debug iÃ§in pencere bilgilerini gÃ¶ster"""
        try:
            if self.main_window:
                logger.info("Pencere Bilgileri:")
                logger.info(f"  BaÅŸlÄ±k: {self.main_window.window_text()}")
                logger.info(f"  Class: {self.main_window.class_name()}")
                self.main_window.print_control_identifiers()
        except Exception as e:
            logger.error(f"Bilgi gÃ¶sterme hatasÄ±: {e}")


def tek_recete_isle(bot, recete_sira_no, rapor_takip, session_logger=None):
    """
    Tek bir reÃ§ete iÃ§in tÃ¼m iÅŸlemleri yap

    Args:
        bot: BotanikBot instance
        recete_sira_no: ReÃ§ete sÄ±ra numarasÄ± (1, 2, 3...)
        rapor_takip: RaporTakip instance (CSV kaydÄ± iÃ§in)
        session_logger: SessionLogger instance (oturum loglarÄ± iÃ§in, opsiyonel)

    Returns:
        tuple: (baÅŸarÄ± durumu: bool, medula reÃ§ete no: str veya None, takip sayÄ±sÄ±: int, hata nedeni: str veya None)
    """
    recete_baslangic = time.time()
    adim_sureleri = []

    def log_sure(ad, baslangic, timing_key=None):
        """Bir adÄ±mÄ±n sÃ¼resini kaydet ve yazdÄ±r."""
        sure = time.time() - baslangic
        adim_sureleri.append((ad, sure))
        logger.info(f"â± {ad}: {sure:.2f}s")

        # Timing istatistiÄŸine kaydet
        if timing_key:
            from timing_settings import get_timing_settings
            timing = get_timing_settings()
            timing.kayit_ekle(timing_key, sure)

        return sure

    medula_recete_no = None
    takip_sayisi = 0  # Takip edilen ilaÃ§ sayÄ±sÄ±
    baslik_loglandi = False

    def log_recete_baslik(no_degeri=None):
        """Ãœst baÅŸlÄ±kta ReÃ§ete sÄ±ra ve numarasÄ±nÄ± gÃ¶ster."""
        nonlocal baslik_loglandi
        if baslik_loglandi:
            return
        no_text = no_degeri if no_degeri else (medula_recete_no if medula_recete_no else "-")
        logger.info(f"ğŸ“‹ REÃ‡ETE {recete_sira_no} | No: {no_text}")
        baslik_loglandi = True

    # Ã–NEMLÄ°: Her reÃ§ete iÅŸlemi baÅŸlamadan Ã¶nce "ReÃ§ete kaydÄ± bulunamadÄ±" kontrolÃ¼ yap
    adim_baslangic = time.time()
    recete_kaydi_var = bot.recete_kaydi_var_mi_kontrol()
    log_sure("ReÃ§ete kontrolÃ¼", adim_baslangic, "recete_kontrol")
    if not recete_kaydi_var:
        logger.error("âŒ ReÃ§ete kaydÄ± yok")
        log_recete_baslik()
        return (False, medula_recete_no, takip_sayisi, "ReÃ§ete kaydÄ± bulunamadÄ±")

    # ReÃ§ete notu ve uyarÄ± kontrolÃ¼ KALDIRILDI - retry mekanizmasÄ± gerektiÄŸinde yapacak

    medula_recete_no = bot.recete_no_oku()
    log_recete_baslik(medula_recete_no)

    # Telefon kontrolÃ¼ (ayar aÃ§Ä±ksa)
    from medula_settings import get_medula_settings
    medula_settings = get_medula_settings()
    telefonsuz_atla = medula_settings.get("telefonsuz_atla", False)

    if telefonsuz_atla:
        telefon_var = bot.telefon_numarasi_kontrol()
        if not telefon_var:
            logger.info("â­ Telefon numarasÄ± yok, hasta atlanÄ±yor...")
            # Direkt SONRA butonuna bas ve geÃ§ (3 deneme + popup kontrolÃ¼)
            adim_baslangic = time.time()
            sonra = bot.retry_with_popup_check(
                lambda: bot.sonra_butonuna_tikla(),
                "SONRA butonu"
            )
            log_sure("Sonra butonu (telefon yok)", adim_baslangic, "sonra_butonu")
            if not sonra:
                log_recete_baslik()
                return (False, medula_recete_no, takip_sayisi, "SONRA butonu baÅŸarÄ±sÄ±z (telefon yok)")

            # BaÅŸarÄ±yla atlandÄ±, takip sayÄ±sÄ± 0
            logger.info(f"âœ“ ReÃ§ete {recete_sira_no} atlandÄ± (telefon yok)")
            return (True, medula_recete_no, 0, None)  # BaÅŸarÄ±lÄ± sayÄ±lsÄ±n ama takip 0

    # Genel muayene uyarÄ±sÄ± kontrolÃ¼ (reÃ§ete aÃ§Ä±ldÄ±ktan hemen sonra)
    try:
        if bot.uyari_penceresini_kapat(max_bekleme=0.5):
            logger.info("âœ“ Genel muayene uyarÄ±sÄ± kapatÄ±ldÄ±")
    except Exception as e:
        logger.debug(f"UyarÄ± kontrol hatasÄ±: {e}")

    # Ä°laÃ§ butonuna tÄ±kla (3 deneme + popup kontrolÃ¼)
    adim_baslangic = time.time()
    ilac_butonu = bot.retry_with_popup_check(
        lambda: bot.ilac_butonuna_tikla(),
        "Ä°laÃ§ butonu"
    )
    log_sure("Ä°laÃ§ butonu", adim_baslangic, "ilac_butonu")
    if not ilac_butonu:
        log_recete_baslik()
        return (False, medula_recete_no, takip_sayisi, "Ä°laÃ§ butonu baÅŸarÄ±sÄ±z")

    # "KullanÄ±lan Ä°laÃ§ Listesi" ekranÄ±nÄ±n yÃ¼klenmesini bekle
    adim_baslangic = time.time()
    ilac_ekrani = bot.ilac_ekrani_yuklendi_mi(max_bekleme=3)
    log_sure("Ä°laÃ§ ekranÄ± yÃ¼kleme", adim_baslangic, "ilac_ekran_bekleme")
    if not ilac_ekrani:
        logger.error("âŒ Ä°laÃ§ ekranÄ± yÃ¼klenemedi")
        log_recete_baslik()
        return (False, medula_recete_no, takip_sayisi, "Ä°laÃ§ ekranÄ± yÃ¼klenemedi")

    # Y butonuna tÄ±kla
    ana_pencere = bot.main_window
    adim_baslangic = time.time()
    y_butonu = bot.y_tusuna_tikla()
    log_sure("Y butonu", adim_baslangic, "y_butonu")

    # Ä°laÃ§ Listesi penceresini akÄ±llÄ± bekleme ile bul (max 1 saniye)
    # Ã–NEMLÄ°: Y'ye tÄ±klama baÅŸarÄ±lÄ± dÃ¶nse bile, popup yÃ¼zÃ¼nden Ä°laÃ§ Listesi Ã§Ä±kmayabilir!
    adim_baslangic = time.time()
    ilac_penceresi_bulundu = False
    max_bekleme = 1.0  # Maksimum 1 saniye bekle
    bekleme_baslangic = time.time()

    while time.time() - bekleme_baslangic < max_bekleme:
        ilac_penceresi_bulundu = bot.yeni_pencereyi_bul("Ä°laÃ§ Listesi")
        if ilac_penceresi_bulundu:
            break  # BULUNDU! Hemen devam et
        time.sleep(bot.timing.get("pencere_bulma"))

    log_sure("Ä°laÃ§ penceresi bulma", adim_baslangic, "pencere_bulma")

    # Ä°laÃ§ Listesi bulunamadÄ±ysa ESC tuÅŸu ile popup kapat ve Y'yi tekrar dene
    if not ilac_penceresi_bulundu:
        logger.info("âš  Ä°laÃ§ Listesi bulunamadÄ± â†’ ESC tuÅŸuna basÄ±lÄ±yor (LABA/LAMA uyarÄ±sÄ± kapatma)")
        send_keys("{ESC}")
        logger.info("âœ“ ESC tuÅŸuna basÄ±ldÄ±")
        time.sleep(0.5)

        # Y butonuna tekrar tÄ±kla
        logger.info("ğŸ”„ Y tuÅŸuna tekrar basÄ±lÄ±yor...")
        adim_baslangic = time.time()
        y_butonu = bot.y_tusuna_tikla()
        log_sure("Y butonu (ESC sonrasÄ±)", adim_baslangic, "y_butonu")

        # Ä°laÃ§ Listesi penceresini tekrar ara
        bekleme_baslangic = time.time()
        max_bekleme = 1.0

        while time.time() - bekleme_baslangic < max_bekleme:
            ilac_penceresi_bulundu = bot.yeni_pencereyi_bul("Ä°laÃ§ Listesi")
            if ilac_penceresi_bulundu:
                logger.info("âœ“ Ä°laÃ§ Listesi bulundu (ESC + Y sonrasÄ±)")
                break
            time.sleep(bot.timing.get("pencere_bulma"))

        log_sure("Ä°laÃ§ penceresi bulma (ESC sonrasÄ±)", adim_baslangic, "pencere_bulma")

    # Ä°laÃ§ Listesi hala bulunamadÄ±ysa ENTER tuÅŸu ile popup kapat (2. deneme)
    if not ilac_penceresi_bulundu:
        logger.info("âš  Ä°laÃ§ Listesi hala bulunamadÄ± â†’ ENTER basÄ±lÄ±yor...")
        time.sleep(1.0)
        send_keys("{ENTER}")
        logger.info("âœ“ ENTER tuÅŸuna basÄ±ldÄ± (1. deneme)")

        # Ä°laÃ§ Listesi penceresini tekrar ara
        adim_baslangic = time.time()
        bekleme_baslangic = time.time()
        max_bekleme = 1.0

        while time.time() - bekleme_baslangic < max_bekleme:
            ilac_penceresi_bulundu = bot.yeni_pencereyi_bul("Ä°laÃ§ Listesi")
            if ilac_penceresi_bulundu:
                logger.info("âœ“ Ä°laÃ§ Listesi bulundu (ENTER sonrasÄ±)")
                break
            time.sleep(bot.timing.get("pencere_bulma"))

        log_sure("Ä°laÃ§ penceresi bulma (ENTER sonrasÄ±)", adim_baslangic, "pencere_bulma")

    # Hala bulunamadÄ±ysa ENTER tuÅŸu ile popup kapat (3. deneme)
    if not ilac_penceresi_bulundu:
        logger.info("âš  Ä°laÃ§ Listesi hala bulunamadÄ± â†’ 1 saniye bekleyip tekrar ENTER basÄ±lÄ±yor...")
        time.sleep(1.0)
        send_keys("{ENTER}")
        logger.info("âœ“ ENTER tuÅŸuna basÄ±ldÄ± (2. deneme)")

        # Y butonuna tekrar tÄ±kla
        time.sleep(bot.timing.get("laba_sonrasi_bekleme"))
        adim_baslangic = time.time()
        y_butonu = bot.y_tusuna_tikla()
        log_sure("Y butonu (2. ENTER sonrasÄ±)", adim_baslangic, "y_ikinci_deneme")

        # Ä°laÃ§ Listesi penceresini tekrar ara
        adim_baslangic = time.time()
        bekleme_baslangic = time.time()
        max_bekleme = 1.0

        while time.time() - bekleme_baslangic < max_bekleme:
            ilac_penceresi_bulundu = bot.yeni_pencereyi_bul("Ä°laÃ§ Listesi")
            if ilac_penceresi_bulundu:
                logger.info("âœ“ Ä°laÃ§ Listesi bulundu (2. ENTER + Y sonrasÄ±)")
                break
            time.sleep(bot.timing.get("pencere_bulma"))

        log_sure("Ä°laÃ§ penceresi bulma (2. deneme)", adim_baslangic, "pencere_bulma")

    # Hala bulunamadÄ±ysa gerÃ§ek hata
    if not ilac_penceresi_bulundu:
        logger.error("âŒ Ä°laÃ§ Listesi penceresi bulunamadÄ± (2x ENTER + Y sonrasÄ± bile)")
        log_recete_baslik()
        return (False, medula_recete_no, takip_sayisi, "Ä°laÃ§ Listesi penceresi bulunamadÄ±")

    # "Bizden AlÄ±nmayanlarÄ± SeÃ§" butonunu ara
    adim_baslangic = time.time()
    alinmayan_secildi = bot.bizden_alinanlarin_sec_tusuna_tikla()
    log_sure("AlÄ±nmayanlarÄ± SeÃ§", adim_baslangic, "alinmayanlari_sec")

    # EÄŸer buton bulunamadÄ±ysa â†’ LABA/LAMA veya Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± uyarÄ±sÄ± var olabilir
    if not alinmayan_secildi:
        logger.info("âš  Bizden AlÄ±nmayanlarÄ± SeÃ§ bulunamadÄ± â†’ LABA/LAMA kontrolÃ¼ yapÄ±lÄ±yor...")

        # 1. LABA/LAMA kontrol ve kapat
        laba_baslangic = time.time()
        laba_kapatildi = bot.laba_lama_uyarisini_kapat(max_bekleme=1.5)
        log_sure("LABA/LAMA kontrol", laba_baslangic, "laba_uyari")

        # 2. LABA/LAMA kapatÄ±ldÄ±ysa, Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± kontrol ve kapat
        ilac_cakismasi_kapatildi = False
        if laba_kapatildi:
            logger.info("âš  LABA/LAMA kapatÄ±ldÄ± â†’ Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± kontrolÃ¼ yapÄ±lÄ±yor...")
            ilac_baslangic = time.time()
            ilac_cakismasi_kapatildi = bot.ilac_cakismasi_uyarisini_kapat(max_bekleme=1.5)
            log_sure("Ä°laÃ§ Ã‡akÄ±ÅŸmasÄ± kontrol (LABA sonrasÄ±)", ilac_baslangic, "ilac_cakismasi_uyari")

        # 3. Herhangi bir popup kapatÄ±ldÄ±ysa Ä°laÃ§ Listesi penceresini tekrar bul
        if laba_kapatildi or ilac_cakismasi_kapatildi:
            time.sleep(bot.timing.get("laba_sonrasi_bekleme"))

            # Ä°laÃ§ Listesi penceresini tekrar bul
            adim_baslangic = time.time()
            ilac_penceresi_bulundu = bot.yeni_pencereyi_bul("Ä°laÃ§ Listesi")
            log_sure("Ä°laÃ§ penceresi 2. bulma", adim_baslangic, "pencere_bulma")

            if ilac_penceresi_bulundu:
                # Tekrar "Bizden AlÄ±nmayanlarÄ± SeÃ§" butonunu ara
                adim_baslangic = time.time()
                alinmayan_secildi = bot.bizden_alinanlarin_sec_tusuna_tikla()
                log_sure("AlÄ±nmayanlarÄ± SeÃ§ (2. deneme)", adim_baslangic, "alinmayanlari_sec")

        # Hala bulanamadÄ±ysa hata
        if not alinmayan_secildi:
            logger.error("âŒ Bizden AlÄ±nmayanlarÄ± SeÃ§ butonu bulunamadÄ± (2 deneme)")
            log_recete_baslik()
            return (False, medula_recete_no, takip_sayisi, "Bizden AlÄ±nmayanlarÄ± SeÃ§ butonu bulunamadÄ±")

    # Ä°laÃ§larÄ±n seÃ§ilmesini bekle - maksimum 3 saniye, ama seÃ§ili ilaÃ§ bulunca devam et
    adim_baslangic = time.time()
    ilac_var = False
    pencere_kapandi = False

    # Dinamik bekleme: Ä°laÃ§ seÃ§ilene kadar kontrol et (max 3 saniye)
    max_wait = 3.0
    check_interval = 0.3
    max_checks = int(max_wait / check_interval)

    for check_count in range(max_checks):
        # Optimizasyon: Ä°lk kontrol hemen, sonraki kontroller 0.3s aralÄ±kla
        if check_count > 0:
            time.sleep(check_interval)

        # Ä°laÃ§larÄ±n seÃ§ilip seÃ§ilmediÄŸini kontrol et
        cells = bot.main_window.descendants(control_type="DataItem")
        secili_var = False
        satir_sayisi = 0

        for cell in cells:
            try:
                cell_name = cell.window_text()
                if "SeÃ§im satÄ±r" in cell_name:
                    satir_sayisi += 1
                    try:
                        value = cell.legacy_properties().get('Value', '')
                        if value == "SeÃ§ili":
                            secili_var = True
                            ilac_var = True
                            logger.info(f"âœ“ SeÃ§ili ilaÃ§ var ({(check_count + 1) * check_interval:.1f}s)")
                            break
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")
            except Exception as e:
                logger.debug(f"Operation failed: {type(e).__name__}")

        # Ä°laÃ§ bulunduysa erken Ã§Ä±k
        if secili_var:
            break

        # Ä°lk 4 kontrol sonrasÄ± (1.2s) durumu deÄŸerlendir
        if check_count == 3:
            if satir_sayisi == 0:
                # HiÃ§ ilaÃ§ satÄ±rÄ± yok
                logger.info("âœ— HiÃ§ ilaÃ§ satÄ±rÄ± yok, bekleme sonlandÄ±rÄ±lÄ±yor")
                break
            elif not secili_var:
                # Ä°laÃ§ satÄ±rlarÄ± var ama seÃ§ili deÄŸil - 1.2s yeterli
                logger.debug(f"{satir_sayisi} ilaÃ§ satÄ±rÄ± var ama seÃ§ili deÄŸil, bekleme sonlandÄ±rÄ±lÄ±yor")
                break

    if ilac_var:
        bot.ilk_ilaca_sag_tik_ve_takip_et()
        # Takip edilen ilaÃ§ sayÄ±sÄ±nÄ± al
        var_mi, takip_sayisi = bot.ilac_secili_mi_kontrol()
    else:
        var_mi, takip_sayisi = bot.ilac_secili_mi_kontrol()
        if var_mi:
            bot.ilk_ilaca_sag_tik_ve_takip_et()
        else:
            logger.info("âœ— SeÃ§ili ilaÃ§ yok")
            logger.info("â†’ Takip Et atlandÄ±")
            kapatma_baslangic = time.time()
            bot.ilac_listesi_penceresini_kapat()
            log_sure("Ä°laÃ§ penceresi kapatma", kapatma_baslangic, "kapat_butonu")
            pencere_kapandi = True

    log_sure("Ä°laÃ§ seÃ§imi", adim_baslangic, "ilac_secim_bekleme")

    # Her iki durumda da Ä°laÃ§ Listesi penceresini kapat
    if not pencere_kapandi:
        adim_baslangic = time.time()
        bot.ilac_listesi_penceresini_kapat()
        log_sure("Ä°laÃ§ penceresi kapatma", adim_baslangic, "kapat_butonu")

    # Ana Medula penceresine geri dÃ¶n (main_window'u geri yÃ¼kle)
    bot.main_window = ana_pencere

    # Geri DÃ¶n butonuna tÄ±kla
    adim_baslangic = time.time()
    geri_don = bot.geri_don_butonuna_tikla()
    log_sure("Geri DÃ¶n butonu", adim_baslangic, "geri_don_butonu")
    if not geri_don:
        log_recete_baslik()
        return (False, medula_recete_no, takip_sayisi, "Geri DÃ¶n butonu baÅŸarÄ±sÄ±z")

    # Rapor bilgilerini topla ve kaydet (Geri DÃ¶n'den SONRA, reÃ§ete detay ekranÄ±ndayken)
    if rapor_takip:
        try:
            if session_logger:
                session_logger.info("ğŸ”µ Rapor toplama baÅŸlatÄ±lÄ±yor...")

            adim_baslangic = time.time()
            rapor_verileri = bot.rapor_listesini_topla()
            log_sure("Rapor toplama", adim_baslangic, "rapor_toplama")

            if rapor_verileri and rapor_verileri.get('raporlar'):
                ad_soyad = rapor_verileri.get('ad_soyad', 'Bilinmeyen')
                telefon = rapor_verileri.get('telefon', '')
                raporlar = rapor_verileri.get('raporlar', [])

                # RaporlarÄ± CSV'ye kaydet
                rapor_takip.toplu_rapor_ekle(ad_soyad, telefon, raporlar)
                logger.info(f"âœ“ Hasta raporlarÄ± kaydedildi: {ad_soyad}")
                if session_logger:
                    session_logger.basari(f"âœ… {len(raporlar)} rapor CSV'ye kaydedildi - {ad_soyad} ({telefon})")
            else:
                logger.info("Bu hastada rapor bulunamadÄ± veya rapor okuma baÅŸarÄ±sÄ±z")
                if session_logger:
                    if rapor_verileri:
                        session_logger.warning(f"âš ï¸ Rapor bulunamadÄ± - {rapor_verileri.get('ad_soyad', 'Bilinmeyen')}")
                    else:
                        session_logger.warning("âš ï¸ Rapor okuma baÅŸarÄ±sÄ±z (rapor butonu tÄ±klanamadÄ±)")
        except Exception as e:
            logger.warning(f"Rapor kaydetme hatasÄ± (devam ediliyor): {e}")
            if session_logger:
                session_logger.error(f"âŒ Rapor kaydetme hatasÄ±: {e}")

    # SONRA butonuna tÄ±klayarak bir sonraki reÃ§eteye geÃ§ (3 deneme + popup kontrolÃ¼)
    adim_baslangic = time.time()
    sonra = bot.retry_with_popup_check(
        lambda: bot.sonra_butonuna_tikla(),
        "SONRA butonu"
    )
    log_sure("Sonra butonu", adim_baslangic, "sonra_butonu")
    if not sonra:
        log_recete_baslik()
        return (False, medula_recete_no, takip_sayisi, "SONRA butonu baÅŸarÄ±sÄ±z")

    # Toplam reÃ§ete sÃ¼resi
    toplam_sure = time.time() - recete_baslangic
    if toplam_sure >= 60:
        dakika = int(toplam_sure // 60)
        saniye = int(toplam_sure % 60)
        logger.info(f"ğŸ• TOPLAM: {dakika}dk {saniye}s")
    else:
        logger.info(f"ğŸ• TOPLAM: {toplam_sure:.2f}s")

    return (True, medula_recete_no, takip_sayisi, None)


def console_pencereyi_ayarla():
    """Console penceresini MEDULA'nÄ±n saÄŸÄ±na yerleÅŸtir"""
    try:
        logger.info("ğŸ”µ Konsol konumlandÄ±rma baÅŸlatÄ±lÄ±yor...")

        # Ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ al
        user32 = ctypes.windll.user32
        screen_width = user32.GetSystemMetrics(0)
        screen_height = user32.GetSystemMetrics(1)
        logger.info(f"  Ekran boyutu: {screen_width}x{screen_height}")

        # MEDULA penceresini bul ve konumunu al
        medula_hwnd = None
        medula_rect = None
        try:
            logger.info("  MEDULA penceresi aranÄ±yor...")
            # MEDULA penceresini baÅŸlÄ±ktan bul
            from pywinauto import Desktop
            desktop = Desktop(backend="uia")
            for window in desktop.windows():
                try:
                    window_text = window.window_text()
                    if window_text and "MEDULA" in window_text and "BotanikEOS" not in window_text:
                        medula_hwnd = window.handle
                        medula_rect = win32gui.GetWindowRect(medula_hwnd)
                        logger.info(f"  âœ“ MEDULA bulundu: x={medula_rect[0]}, y={medula_rect[1]}, w={medula_rect[2]-medula_rect[0]}, h={medula_rect[3]-medula_rect[1]}")
                        break
                except Exception as e:
                    logger.debug(f"  Pencere kontrol hatasÄ±: {e}")
                    continue
        except Exception as e:
            logger.warning(f"  MEDULA penceresi arama hatasÄ±: {e}")

        # Konsol boyutlarÄ±
        console_width = 500  # Konsol geniÅŸliÄŸi (log okumak iÃ§in yeterli)
        console_height = screen_height - 40  # Taskbar iÃ§in 40px boÅŸluk

        # MEDULA bulunduysa onun saÄŸÄ±na yerleÅŸtir, bulunamadÄ±ysa sabit konum
        if medula_rect:
            console_x = medula_rect[2] + 5  # MEDULA'nÄ±n saÄŸ kenarÄ±ndan 5px saÄŸÄ±nda
            logger.info(f"  Konsol MEDULA'nÄ±n saÄŸÄ±na yerleÅŸtirilecek: x={console_x}")
        else:
            # MEDULA bulunamadÄ±, ekranÄ±n sol ortasÄ±na yerleÅŸtir
            console_x = 850
            logger.warning(f"  âš ï¸ MEDULA bulunamadÄ±, sabit konuma yerleÅŸtiriliyor: x={console_x}")
        console_y = 0  # EkranÄ±n en Ã¼stÃ¼nden baÅŸla

        # Console penceresini al
        logger.info("  Konsol penceresi handle alÄ±nÄ±yor...")
        kernel32 = ctypes.windll.kernel32
        console_hwnd = kernel32.GetConsoleWindow()

        if console_hwnd:
            logger.info(f"  âœ“ Konsol penceresi bulundu (hwnd={console_hwnd})")

            # Console buffer boyutunu artÄ±r (daha fazla geÃ§miÅŸ tutmak iÃ§in)
            try:
                subprocess.run('mode con: lines=9999', shell=True, capture_output=True)
            except Exception as e:
                logger.debug(f"  Mode con hatasÄ±: {type(e).__name__}")

            # Pencereyi gÃ¶rÃ¼nÃ¼r yap (minimize ise restore et)
            logger.info("  Konsol penceresi restore ediliyor...")
            win32gui.ShowWindow(console_hwnd, win32con.SW_RESTORE)
            time.sleep(0.09)

            # Ã–nce SetWindowPos ile yerleÅŸtir
            logger.info(f"  SetWindowPos ile konumlandÄ±rÄ±lÄ±yor: x={console_x}, y={console_y}, w={console_width}, h={console_height}")
            flags = win32con.SWP_SHOWWINDOW
            win32gui.SetWindowPos(
                console_hwnd,
                win32con.HWND_TOP,
                console_x, console_y,
                console_width, console_height,
                flags
            )
            time.sleep(0.045)

            # MoveWindow ile kesin yerleÅŸtir
            logger.info("  MoveWindow ile kesin konumlandÄ±rÄ±lÄ±yor...")
            win32gui.MoveWindow(console_hwnd, console_x, console_y, console_width, console_height, True)
            time.sleep(0.045)

            # DoÄŸrulama: gerÃ§ek pozisyonu kontrol et
            try:
                gercek_rect = win32gui.GetWindowRect(console_hwnd)
                logger.info(f"  âœ“ Konsol yerleÅŸtirildi: x={gercek_rect[0]}, y={gercek_rect[1]}, w={gercek_rect[2]-gercek_rect[0]}, h={gercek_rect[3]-gercek_rect[1]}")
            except Exception as e:
                logger.debug(f"  Pozisyon doÄŸrulama hatasÄ±: {e}")

            logger.info(f"âœ… Konsol konumlandÄ±rma tamamlandÄ±!")
        else:
            logger.warning("âŒ Konsol penceresi bulunamadÄ± (hwnd=0)")

    except Exception as e:
        logger.error(f"âŒ Konsol konumlandÄ±rma hatasÄ±: {e}", exc_info=True)


def main():
    """Ana fonksiyon - ReÃ§ete dÃ¶ngÃ¼sÃ¼"""
    program_baslangic = time.time()

    logger.info("=" * 40)
    logger.info("Botanik Bot BaÅŸlatÄ±lÄ±yor...")
    logger.info("=" * 40)

    # Bot oluÅŸtur
    bot = BotanikBot()

    # Rapor takip sistemi oluÅŸtur ve bot'a ekle
    try:
        bot.rapor_takip = RaporTakip()
        logger.info("âœ“ Rapor takip sistemi baÅŸlatÄ±ldÄ±")
    except Exception as e:
        logger.warning(f"Rapor takip sistemi baÅŸlatÄ±lamadÄ±: {e}")
        bot.rapor_takip = None

    # Medulla'ya baÄŸlan (ilk baÄŸlantÄ± - pencere yerleÅŸtirme ile)
    if not bot.baglanti_kur("MEDULA", ilk_baglanti=True):
        logger.error("âŒ MEDULA bulunamadÄ±")
        return

    # Medula yerleÅŸtirildikten SONRA console'u yerleÅŸtir
    console_pencereyi_ayarla()

    # ReÃ§ete dÃ¶ngÃ¼sÃ¼ - SONRA butonu olduÄŸu sÃ¼rece devam et
    recete_sayisi = 0
    basarili_receteler = 0

    while True:
        recete_sayisi += 1
        logger.info("=" * 40)

        try:
            # Tek reÃ§ete iÅŸle
            basari, medula_no, takip_sayisi, hata_nedeni = tek_recete_isle(bot, recete_sayisi, bot.rapor_takip)
            logger.info("=" * 40)
            if not basari:
                # ReÃ§ete kaydÄ± bulunamadÄ± veya SONRA butonu bulunamadÄ± - dÃ¶ngÃ¼den Ã§Ä±k
                break
            else:
                basarili_receteler += 1

        except SistemselHataException as e:
            # Sistemsel hata tespit edildi - MEDULA'yÄ± yeniden baÅŸlat
            logger.error(f"âš ï¸ Sistemsel hata yakalandÄ±: {e}")

            # MEDULA'yÄ± yeniden baÅŸlat ve giriÅŸ yap (grup bilgisini kullan)
            if medula_yeniden_baslat_ve_giris_yap(bot, grup):
                # BaÅŸarÄ±yla yeniden baÅŸlatÄ±ldÄ± - aynÄ± reÃ§eteyi tekrar dene
                logger.info(f"ğŸ”„ ReÃ§ete {recete_sayisi} tekrar iÅŸlenecek...")
                recete_sayisi -= 1  # SayaÃ§ geri alÄ±nÄ±yor, Ã§Ã¼nkÃ¼ while dÃ¶ngÃ¼sÃ¼ baÅŸÄ±nda tekrar artacak
                time.sleep(2)
                continue
            else:
                # Yeniden baÅŸlatma baÅŸarÄ±sÄ±z - programdan Ã§Ä±k
                logger.error("âŒ MEDULA yeniden baÅŸlatÄ±lamadÄ±, program sonlandÄ±rÄ±lÄ±yor")
                break

    toplam_sure = time.time() - program_baslangic
    ortalama_sure = toplam_sure / basarili_receteler if basarili_receteler > 0 else 0

    # SÃ¼re formatÄ±
    if toplam_sure >= 60:
        t_dk = int(toplam_sure // 60)
        t_sn = int(toplam_sure % 60)
        toplam_str = f"{t_dk}dk {t_sn}s"
    else:
        toplam_str = f"{toplam_sure:.1f}s"

    if ortalama_sure >= 60:
        o_dk = int(ortalama_sure // 60)
        o_sn = int(ortalama_sure % 60)
        ortalama_str = f"{o_dk}dk {o_sn}s"
    else:
        ortalama_str = f"{ortalama_sure:.1f}s"

    logger.info("=" * 40)
    logger.info(f"âœ“ TamamlandÄ±: {basarili_receteler} reÃ§ete")
    logger.info(f"ğŸ• Toplam: {toplam_str}")
    logger.info(f"ğŸ“Š Ortalama: {ortalama_str}/reÃ§ete")
    logger.info("=" * 40)


# ==================== YARDIMCI FONKSÄ°YONLAR ====================

def popup_kontrol_ve_kapat():
    """
    Popup/dialog pencerelerini otomatik algÄ±la ve kapat

    Returns:
        bool: Popup kapatÄ±ldÄ±ysa True
    """
    try:
        from pywinauto import Desktop

        desktop = Desktop(backend="uia")
        windows = desktop.windows()

        for window in windows:
            try:
                # Sadece gÃ¶rÃ¼nÃ¼r pencerelere bak
                if not window.is_visible():
                    continue

                # Dialog/Modal pencere mi?
                window_text = window.window_text()

                # BoÅŸ baÅŸlÄ±k veya Ã§ok kÄ±sa baÅŸlÄ±klÄ± pencereler genelde popup
                if not window_text or len(window_text) < 3:
                    continue

                # KÃ¼Ã§Ã¼k pencereler (popup olabilir)
                try:
                    rect = window.rectangle()
                    width = rect.width()
                    height = rect.height()

                    # Ã‡ok bÃ¼yÃ¼k pencereler ana penceredir, skip
                    if width > 800 or height > 600:
                        continue

                    # Ã‡ok kÃ¼Ã§Ã¼k pencereler de anlamsÄ±z
                    if width < 100 or height < 50:
                        continue
                except Exception as e:
                    logger.debug(f"Window size check failed: {type(e).__name__}")
                    continue

                # Pencere iÃ§inde "Tamam", "OK", "Kapat", "X", "Evet", "HayÄ±r" gibi butonlar ara
                kapat_butonlari = ["Tamam", "OK", "Kapat", "Ä°ptal", "Evet", "HayÄ±r", "Close", "Cancel"]

                for buton_text in kapat_butonlari:
                    try:
                        buton = window.child_window(title=buton_text, control_type="Button")
                        if buton.exists(timeout=0.5):
                            logger.info(f"âœ“ Popup tespit edildi: '{window_text}', kapatÄ±lÄ±yor...")
                            buton.click()
                            time.sleep(0.3)
                            return True
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                # X (Close) butonu ara
                try:
                    close_button = window.child_window(title="Close", control_type="Button")
                    if close_button.exists(timeout=0.5):
                        logger.info(f"âœ“ Popup tespit edildi (X): '{window_text}', kapatÄ±lÄ±yor...")
                        close_button.click()
                        time.sleep(0.3)
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            except Exception as e:
                continue

        return False
    except Exception as e:
        logger.debug(f"Popup kontrol hatasÄ±: {e}")
        return False


def sistemsel_hata_kontrol():
    """
    MEDULA penceresinde "YazÄ±lÄ±msal veya sistemsel bir hata oluÅŸtu." label'Ä±nÄ± kontrol et

    Returns:
        bool: Sistemsel hata tespit edildiyse True
    """
    try:
        from pywinauto import Desktop

        desktop = Desktop(backend="uia")
        windows = desktop.windows()

        for window in windows:
            try:
                # MEDULA penceresi mi?
                window_text = window.window_text()
                if not window_text or "MEDULA" not in window_text:
                    continue

                # Pencere gÃ¶rÃ¼nÃ¼r mÃ¼?
                if not window.is_visible():
                    continue

                # "YazÄ±lÄ±msal veya sistemsel bir hata oluÅŸtu." text elementini ara
                try:
                    # Name veya title ile ara
                    hata_text = window.child_window(
                        title_re=".*[Yy]azÄ±lÄ±msal veya sistemsel.*hata.*",
                        control_type="Text"
                    )
                    if hata_text.exists(timeout=0.3):
                        logger.error("âŒ SÄ°STEMSEL HATA TESPÄ°T EDÄ°LDÄ°: 'YazÄ±lÄ±msal veya sistemsel bir hata oluÅŸtu.'")
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

                # Alternatif: TÃ¼m text elementlerini tara
                try:
                    texts = window.descendants(control_type="Text")
                    for text in texts:
                        raw_content = text.window_text()
                        text_content = raw_content.lower() if raw_content else ""
                        if "yazÄ±lÄ±msal" in text_content and "sistemsel" in text_content and "hata" in text_content:
                            logger.error(f"âŒ SÄ°STEMSEL HATA TESPÄ°T EDÄ°LDÄ°: '{raw_content}'")
                            return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            except Exception as e:
                continue

        return False
    except Exception as e:
        logger.debug(f"Sistemsel hata kontrol hatasÄ±: {e}")
        return False


def recete_kaydi_bulunamadi_mi(bot):
    """
    "ReÃ§ete kaydÄ± bulunamadÄ±" mesajÄ±nÄ± kontrol et

    Args:
        bot (BotanikBot): Bot instance

    Returns:
        bool: Mesaj varsa True (gÃ¶rev bitti)
    """
    try:
        if not bot.main_window:
            return False

        # "ReÃ§ete kaydÄ± bulunamadÄ±." textini ara (OPTIMIZE: timeout 1s â†’ 0.3s)
        try:
            text_element = bot.main_window.child_window(title_re=".*ReÃ§ete kaydÄ± bulunamadÄ±.*", control_type="Text")
            if text_element.exists(timeout=0.3):
                logger.info("âœ“ 'ReÃ§ete kaydÄ± bulunamadÄ±' mesajÄ± tespit edildi - GÃ¶rev tamamlandÄ±!")
                return True
        except Exception as e:
            logger.debug(f"Operation failed: {type(e).__name__}")

        # Alternatif: Internet Explorer_Server iÃ§inde ara
        try:
            from pywinauto import Desktop
            desktop = Desktop(backend="uia")

            for window in desktop.windows():
                try:
                    if "MEDULA" in window.window_text():
                        # TÃ¼m text elementlerini tara
                        texts = window.descendants(control_type="Text")
                        for text in texts:
                            raw_text = text.window_text()
                            if raw_text and "bulunamadÄ±" in raw_text.lower():
                                logger.info(f"âœ“ GÃ¶rev bitiÅŸi mesajÄ±: '{raw_text}'")
                                return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")
        except Exception as e:
            logger.debug(f"Operation failed: {type(e).__name__}")

        return False
    except Exception as e:
        logger.debug(f"GÃ¶rev bitiÅŸi kontrolÃ¼ hatasÄ±: {e}")
        return False


def medula_taskkill():
    """
    MEDULA programÄ±nÄ± zorla kapat (taskkill)
    SADECE BotanikMedula.exe kapatÄ±lÄ±r (BotanikEczane.exe KAPANMAZ)

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        import subprocess

        # SADECE BotanikMedula.exe'yi kapat
        result = subprocess.run(
            ["taskkill", "/F", "/IM", "BotanikMedula.exe"],
            capture_output=True,
            text=True,
            timeout=5
        )

        if result.returncode == 0:
            logger.info("âœ“ BotanikMedula.exe kapatÄ±ldÄ± (taskkill)")
            time.sleep(2)  # ProgramÄ±n tamamen kapanmasÄ± iÃ§in bekle
            return True
        else:
            logger.warning("âš  Taskkill baÅŸarÄ±sÄ±z: BotanikMedula.exe bulunamadÄ±")
            return False
    except Exception as e:
        logger.error(f"âŒ Taskkill hatasÄ±: {e}")
        return False


def medula_yeniden_baslat_ve_giris_yap(bot, grup="A"):
    """
    Sistemsel hata durumunda MEDULA'yÄ± yeniden baÅŸlatÄ±r ve giriÅŸ yapar

    Args:
        bot: BotanikBot instance
        grup: Hangi gruba gidileceÄŸi ("A", "B" veya "C")

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True

    Raises:
        Exception: Yeniden baÅŸlatma baÅŸarÄ±sÄ±z olursa
    """
    try:
        from medula_settings import get_medula_settings
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        logger.info("=" * 60)
        logger.error("ğŸ”„ SÄ°STEMSEL HATA - MEDULA YENÄ°DEN BAÅLATILIYOR...")
        logger.info("=" * 60)

        # 1. MEDULA'yÄ± kapat
        logger.info("1ï¸âƒ£ MEDULA kapatÄ±lÄ±yor...")
        medula_taskkill()
        time.sleep(3)  # ProgramÄ±n tamamen kapanmasÄ± iÃ§in ekstra bekleme

        # 2. AyarlarÄ± yÃ¼kle
        medula_settings = get_medula_settings()

        # 3. MEDULA'yÄ± aÃ§ ve giriÅŸ yap
        logger.info("2ï¸âƒ£ MEDULA aÃ§Ä±lÄ±yor ve giriÅŸ yapÄ±lÄ±yor...")
        if not medula_ac_ve_giris_yap(medula_settings):
            logger.error("âŒ MEDULA aÃ§ma/giriÅŸ baÅŸarÄ±sÄ±z")
            return False

        # 4. Bot'un baÄŸlantÄ±sÄ±nÄ± yenile
        logger.info("3ï¸âƒ£ Bot baÄŸlantÄ±sÄ± yenileniyor...")
        # Cache'i temizle
        bot.medula_hwnd = None
        bot.medula_pid = None

        # Yeni baÄŸlantÄ± kur
        if not bot.baglanti_kur("MEDULA", ilk_baglanti=False):
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± kurulamadÄ±")
            return False

        # 5. Ana sayfaya git
        logger.info("â³ Ana sayfa yÃ¼klenmesi bekleniyor...")
        time.sleep(timing.get("ana_sayfa"))

        # 6. ReÃ§ete Listesi'ne git
        logger.info("4ï¸âƒ£ ReÃ§ete Listesi aÃ§Ä±lÄ±yor...")
        try:
            if not recete_listesi_ac(bot):
                logger.error("âŒ ReÃ§ete Listesi aÃ§Ä±lamadÄ±")
                return False
        except SistemselHataException as e:
            logger.error(f"âš ï¸ ReÃ§ete Listesi aÃ§ma sÄ±rasÄ±nda sistemsel hata: {e}")
            logger.warning("ğŸ”„ MEDULA bir kez daha yeniden baÅŸlatÄ±lacak...")
            # Recursive call - kendini bir kez daha Ã§aÄŸÄ±r
            return medula_yeniden_baslat_ve_giris_yap(bot, grup)

        # 7. DÃ¶nem seÃ§ (index=2)
        logger.info("5ï¸âƒ£ DÃ¶nem seÃ§iliyor...")
        if not donem_sec(bot, index=2):
            logger.warning("âš  DÃ¶nem 2 seÃ§ilemedi, dÃ¶nem 1 deneniyor...")
            if not donem_sec(bot, index=1):
                logger.error("âŒ DÃ¶nem seÃ§imi baÅŸarÄ±sÄ±z")
                return False

        # 8. Grup seÃ§
        logger.info(f"6ï¸âƒ£ Grup {grup} seÃ§iliyor...")
        if not grup_butonuna_tikla(bot, grup):
            logger.error(f"âŒ Grup {grup} seÃ§imi baÅŸarÄ±sÄ±z")
            return False

        # Pencereyi yenile
        bot.baglanti_kur("MEDULA", ilk_baglanti=False)

        # 8.5. ReÃ§ete bulunamadÄ± kontrolÃ¼
        logger.info("ğŸ” ReÃ§ete varlÄ±ÄŸÄ± kontrol ediliyor...")
        if bulunamadi_mesaji_kontrol(bot):
            logger.warning(f"âš  Grup {grup}'da bu dÃ¶nem iÃ§in reÃ§ete bulunamadÄ±")

            # FarklÄ± dÃ¶nemler dene
            donem_bulundu = False
            for donem_index in [1, 0]:  # DÃ¶nem 2 (index 1), DÃ¶nem 1 (index 0) dene
                logger.info(f"ğŸ”„ DÃ¶nem {donem_index + 1} deneniyor...")

                # DÃ¶nem seÃ§
                if not donem_sec(bot, index=donem_index):
                    logger.warning(f"âš  DÃ¶nem {donem_index + 1} seÃ§ilemedi")
                    continue

                # Grup seÃ§
                if not grup_butonuna_tikla(bot, grup):
                    logger.error(f"âŒ Grup {grup} seÃ§imi baÅŸarÄ±sÄ±z")
                    continue

                # Pencereyi yenile
                bot.baglanti_kur("MEDULA", ilk_baglanti=False)

                # Tekrar kontrol et
                if not bulunamadi_mesaji_kontrol(bot):
                    logger.info(f"âœ… DÃ¶nem {donem_index + 1}'de reÃ§ete bulundu!")
                    donem_bulundu = True
                    break
                else:
                    logger.warning(f"âš  DÃ¶nem {donem_index + 1}'de de reÃ§ete bulunamadÄ±")

            if not donem_bulundu:
                # FarklÄ± gruplarÄ± dene
                logger.warning(f"âš  Grup {grup}'da hiÃ§bir dÃ¶nemde reÃ§ete bulunamadÄ±, diÄŸer gruplar deneniyor...")
                for alternatif_grup in ["A", "B", "C"]:
                    if alternatif_grup == grup:
                        continue

                    logger.info(f"ğŸ”„ Grup {alternatif_grup} deneniyor...")

                    # DÃ¶nem seÃ§ (index=2)
                    if not donem_sec(bot, index=2):
                        if not donem_sec(bot, index=1):
                            continue

                    # Grup seÃ§
                    if not grup_butonuna_tikla(bot, alternatif_grup):
                        continue

                    # Pencereyi yenile
                    bot.baglanti_kur("MEDULA", ilk_baglanti=False)

                    # Kontrol et
                    if not bulunamadi_mesaji_kontrol(bot):
                        logger.info(f"âœ… Grup {alternatif_grup}'da reÃ§ete bulundu!")
                        grup = alternatif_grup  # Grubu gÃ¼ncelle
                        donem_bulundu = True
                        break

                if not donem_bulundu:
                    logger.error("âŒ HiÃ§bir grup ve dÃ¶nemde reÃ§ete bulunamadÄ±")
                    return False

        # 9. Ä°lk reÃ§eteyi aÃ§
        logger.info("7ï¸âƒ£ Ä°lk reÃ§ete aÃ§Ä±lÄ±yor...")
        if not ilk_recete_ac(bot):
            logger.error("âŒ Ä°lk reÃ§ete aÃ§Ä±lamadÄ±")
            return False

        logger.info("=" * 60)
        logger.info(f"âœ… MEDULA BAÅARIYLA YENÄ°DEN BAÅLATILDI - GRUP {grup}")
        logger.info("=" * 60)
        time.sleep(2)  # KullanÄ±cÄ±nÄ±n mesajÄ± gÃ¶rmesi iÃ§in

        return True

    except Exception as e:
        logger.error(f"âŒ MEDULA yeniden baÅŸlatma hatasÄ±: {e}")
        import traceback
        traceback.print_exc()
        return False


def masaustu_medula_ac(medula_settings):
    """
    MEDULA programÄ±nÄ± exe dosyasÄ±ndan direkt Ã§alÄ±ÅŸtÄ±r

    Args:
        medula_settings: MedulaSettings instance

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        import os
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        # Ayarlardan exe yolunu al
        exe_path = medula_settings.get("medula_exe_path", "")

        if not exe_path or not os.path.exists(exe_path):
            logger.error(f"MEDULA .exe dosyasÄ± bulunamadÄ±: {exe_path}")
            return False

        logger.info(f"MEDULA programi baslatiliyor: {exe_path}")

        # Subprocess ile exe'yi Ã§alÄ±ÅŸtÄ±r ve process referansÄ±nÄ± sakla
        try:
            process = subprocess.Popen([exe_path])
            logger.info(f"âœ“ MEDULA programi baslatildi (PID: {process.pid})")
        except FileNotFoundError:
            logger.error(f"âŒ Dosya bulunamadÄ±: {exe_path}")
            return False
        except PermissionError:
            logger.error(f"âŒ Dosya Ã§alÄ±ÅŸtÄ±rma yetkisi yok: {exe_path}")
            return False
        except Exception as e:
            logger.error(f"âŒ Process baÅŸlatma hatasÄ±: {e}")
            return False

        logger.info("MEDULA giris penceresi bekleniyor...")
        time.sleep(timing.get("masaustu_simge_bekleme"))

        return True

    except Exception as e:
        logger.error(f"MEDULA programi baslatilamadi: {e}")
        return False


def medula_giris_yap(medula_settings):
    """
    MEDULA giriÅŸ penceresine kullanÄ±cÄ± adÄ± ve ÅŸifre girerek giriÅŸ yap

    Args:
        medula_settings: MedulaSettings instance

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        from pywinauto import Desktop
        import pyautogui
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        logger.info("â³ MEDULA giriÅŸ penceresi bekleniyor...")
        time.sleep(timing.get("giris_pencere_bekleme"))

        # Aktif kullanÄ±cÄ±nÄ±n bilgilerini al
        aktif_kullanici = medula_settings.get_aktif_kullanici()
        if not aktif_kullanici:
            logger.error("âŒ Aktif kullanÄ±cÄ± bulunamadÄ±!")
            return False

        kullanici_index = aktif_kullanici.get("kullanici_index", 0)
        sifre = aktif_kullanici.get("sifre")
        kullanici_ad = aktif_kullanici.get("ad", "KullanÄ±cÄ±")

        if sifre is None or sifre == "":
            logger.error(f"âŒ {kullanici_ad} iÃ§in ÅŸifre ayarlanmamÄ±ÅŸ!")
            return False

        # GiriÅŸ yÃ¶ntemi kontrolÃ¼
        giris_yontemi = medula_settings.get("giris_yontemi", "indeks")
        kullanici_adi_giris = medula_settings.get("kullanici_adi_giris", "")

        if giris_yontemi == "indeks":
            logger.info(f"ğŸ” {kullanici_ad} ile giriÅŸ yapÄ±lÄ±yor (Ä°ndeks yÃ¶ntemi - MEDULA Index: {kullanici_index})")
        else:
            logger.info(f"ğŸ” {kullanici_ad} ile giriÅŸ yapÄ±lÄ±yor (KullanÄ±cÄ± AdÄ± yÃ¶ntemi - MEDULA KullanÄ±cÄ±: {kullanici_adi_giris})")

        desktop = Desktop(backend="uia")

        # GiriÅŸ penceresini bul
        giris_window = None
        for window in desktop.windows():
            try:
                if "BotanikEOS" in window.window_text():
                    giris_window = window
                    break
            except Exception as e:
                logger.debug(f"Operation failed: {type(e).__name__}")

        if not giris_window:
            logger.error("âŒ MEDULA giriÅŸ penceresi bulunamadÄ±")
            return False

        logger.info("âœ“ GiriÅŸ penceresi bulundu")

        # ComboBox'tan kullanÄ±cÄ± seÃ§
        try:
            logger.debug("Kullanici combobox aranÄ±yor...")

            # TÃ¼m UI elementlerini dÃ¶ngÃ¼yle tara ve ComboBox bul
            all_controls = giris_window.descendants()
            combobox = None

            for ctrl in all_controls:
                try:
                    if "COMBOBOX" in ctrl.class_name().upper():
                        combobox = ctrl
                        logger.info(f"Combobox bulundu: {ctrl.class_name()}")
                        break
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            if combobox:
                # ComboBox'Ä±n koordinatlarÄ±nÄ± al
                rect = combobox.rectangle()
                x_center = (rect.left + rect.right) // 2
                y_center = (rect.top + rect.bottom) // 2

                logger.info(f"Combobox koordinatlari: x={x_center}, y={y_center}")

                # Koordinata tÄ±kla
                logger.info("Combobox'a tÄ±klanÄ±yor...")
                pyautogui.click(x_center, y_center)
                time.sleep(0.5)

                # GiriÅŸ yÃ¶ntemine gÃ¶re kullanÄ±cÄ± seÃ§imi
                if giris_yontemi == "kullanici_adi":
                    # KullanÄ±cÄ± adÄ± ile arama
                    if kullanici_adi_giris:
                        logger.info(f"KullanÄ±cÄ± adÄ± yazÄ±lÄ±yor: {kullanici_adi_giris}")
                        pyautogui.typewrite(kullanici_adi_giris, interval=0.1)
                        time.sleep(0.3)
                        logger.info("Enter ile seÃ§iliyor...")
                        pyautogui.press("enter")
                        time.sleep(timing.get("kullanici_secim"))
                        logger.info(f"KullanÄ±cÄ± seÃ§ildi (ad: {kullanici_adi_giris})")
                    else:
                        logger.warning("KullanÄ±cÄ± adÄ± girilmemiÅŸ, varsayÄ±lan kullanÄ±cÄ± seÃ§ilecek")
                        pyautogui.press("enter")
                        time.sleep(timing.get("kullanici_secim"))
                else:
                    # Ä°ndeks ile seÃ§im (mevcut yÃ¶ntem)
                    if kullanici_index > 0:
                        logger.info(f"{kullanici_index} kere DOWN tuÅŸuna basÄ±lÄ±yor...")
                        for i in range(kullanici_index):
                            pyautogui.press('down')
                            time.sleep(0.2)
                    else:
                        logger.info("Index 0, birinci kullanici secilecek")

                    # Enter ile seÃ§
                    logger.info("Enter basilarak kullanici seciliyor...")
                    pyautogui.press("enter")
                    time.sleep(timing.get("kullanici_secim"))
                    logger.info(f"Kullanici secildi (index: {kullanici_index})")
            else:
                logger.warning("Combobox bulunamadÄ±!")

        except Exception as e:
            logger.error(f"ComboBox islemi basarisiz: {e}")
            import traceback
            traceback.print_exc()

        # Åifre textbox'Ä±na geÃ§ ve yaz
        try:
            logger.info("Sifre kutusuna geciliyor...")

            # Åifre textbox'Ä±nÄ± bul
            sifre_textbox = None
            all_controls = giris_window.descendants()

            for ctrl in all_controls:
                try:
                    # Åifre kutusunu automation_id veya class_name ile bul
                    if (hasattr(ctrl, 'automation_id') and ctrl.automation_id() == "txtSifre") or \
                       ("EDIT" in ctrl.class_name().upper() and ctrl != combobox):
                        sifre_textbox = ctrl
                        logger.info(f"Sifre textbox bulundu: {ctrl.class_name()}")
                        break
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            if sifre_textbox:
                # Åifre textbox'Ä±nÄ±n koordinatlarÄ±nÄ± al
                rect = sifre_textbox.rectangle()
                x_center = (rect.left + rect.right) // 2
                y_center = (rect.top + rect.bottom) // 2

                logger.info(f"Sifre textbox koordinatlari: x={x_center}, y={y_center}")

                # Koordinata tÄ±kla
                logger.info("Sifre kutusuna tÄ±klanÄ±yor...")
                pyautogui.click(x_center, y_center)
                time.sleep(0.5)
            else:
                # Bulunamazsa TAB ile dene
                logger.warning("Sifre textbox koordinat ile bulunamadi, TAB ile denenecek")
                pyautogui.press("tab")
                time.sleep(0.3)

            # Åifreyi clipboard ile yapÄ±ÅŸtÄ±r
            logger.info("Sifre clipboard'a kopyalanÄ±yor...")
            import pyperclip
            pyperclip.copy(sifre)
            time.sleep(0.2)

            logger.info("Sifre yapÄ±ÅŸtÄ±rÄ±lÄ±yor...")
            pyautogui.hotkey('ctrl', 'v')
            time.sleep(timing.get("sifre_yazma"))
            logger.info("Sifre girildi")

            # ENTER tuÅŸuna bas
            logger.info("Enter basilÄ±yor...")
            pyautogui.press("enter")
            time.sleep(timing.get("giris_butonu"))
            time.sleep(timing.get("giris_sonrasi_bekleme"))
            logger.info("Giris yapildi, ana sayfa yukleniyor...")
            return True

        except Exception as e:
            logger.error(f"Sifre girisi basarisiz: {e}")
            import traceback
            traceback.print_exc()
            return False

    except Exception as e:
        logger.error(f"MEDULA giris hatasi: {e}")
        import traceback
        traceback.print_exc()
        return False


def recete_listesi_ac(bot):
    """
    MEDULA ana sayfasÄ±nda "ReÃ§ete Listesi" butonuna tÄ±kla

    Args:
        bot: BotanikBot instance

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        if not bot or not bot.main_window:
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± yok")
            return False

        # Ana sayfanÄ±n yÃ¼klenmesi iÃ§in biraz bekle
        logger.info("â³ Ana sayfa yÃ¼klenmesi bekleniyor (2 saniye)...")
        time.sleep(2.0)

        logger.debug("ReÃ§ete Listesi butonu aranÄ±yor...")

        # "ReÃ§ete Listesi" butonunu bul - TÃ¼m butonlarÄ± tara
        try:
            logger.debug("TÃ¼m butonlar taranÄ±yor...")
            all_buttons = bot.main_window.descendants(control_type="Button")
            logger.debug(f"Toplam {len(all_buttons)} buton bulundu")

            # Debug: Ä°lk 20 butonun metinlerini logla
            for i, btn in enumerate(all_buttons[:20]):
                try:
                    btn_text = btn.window_text()
                    if btn_text:
                        logger.info(f"  Buton {i+1}: '{btn_text}'")
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            # Åimdi gerÃ§ekten ReÃ§ete Listesi'ni ara
            for btn in all_buttons:
                try:
                    btn_text = btn.window_text()
                    if btn_text and "ReÃ§ete" in btn_text and "Listesi" in btn_text:
                        logger.info(f"âœ“ ReÃ§ete Listesi butonu bulundu: '{btn_text}'")
                        btn.click_input()
                        logger.info("âœ“ ReÃ§ete Listesi butonuna tÄ±klandÄ±")
                        time.sleep(timing.get("recete_listesi_butonu"))
                        time.sleep(timing.get("recete_listesi_acilma"))
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            logger.warning("Buton text'inde bulunamadÄ±, AutomationId ile denenecek...")
        except Exception as e:
            logger.debug(f"Buton tarama hatasÄ±: {e}")

        # Alternatif: AutomationId ile ara
        try:
            recete_listesi_btn = bot.main_window.descendants(auto_id="form1:menuHtmlCommandExButton31_MOUSE", control_type="Button")
            if recete_listesi_btn and len(recete_listesi_btn) > 0:
                recete_listesi_btn[0].click_input()
                logger.info("âœ“ ReÃ§ete Listesi butonuna tÄ±klandÄ± (AutomationId)")
                time.sleep(timing.get("recete_listesi_butonu"))
                time.sleep(timing.get("recete_listesi_acilma"))
                return True
        except Exception as e:
            logger.debug(f"AutomationId ile bulunamadÄ±: {e}")

        # Son deneme: Title ile ara
        try:
            recete_listesi_btn = bot.main_window.descendants(title_re=".*ReÃ§ete Listesi.*", control_type="Button")
            if recete_listesi_btn and len(recete_listesi_btn) > 0:
                recete_listesi_btn[0].click_input()
                logger.info("âœ“ ReÃ§ete Listesi butonuna tÄ±klandÄ± (Title)")
                time.sleep(timing.get("recete_listesi_butonu"))
                time.sleep(timing.get("recete_listesi_acilma"))
                return True
        except Exception as e:
            logger.debug(f"Title ile bulunamadÄ±: {e}")

        logger.error("âŒ ReÃ§ete Listesi butonu bulunamadÄ± - MEDULA yeniden baÅŸlatÄ±lacak")
        raise SistemselHataException("ReÃ§ete Listesi butonu bulunamadÄ± - MEDULA takÄ±ldÄ± olabilir")
    except Exception as e:
        logger.error(f"âŒ ReÃ§ete Listesi aÃ§ma hatasÄ±: {e} - MEDULA yeniden baÅŸlatÄ±lacak")
        raise SistemselHataException(f"ReÃ§ete Listesi aÃ§ma hatasÄ±: {e}")


def donem_sec(bot, index=2):
    """
    DÃ¶nem seÃ§me combobox'Ä±nda belirtilen index'i seÃ§ (0-based)

    Args:
        bot: BotanikBot instance
        index: SeÃ§ilecek item indexi (varsayÄ±lan: 2 = 3. sÄ±radaki item)

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        import pyautogui
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        if not bot or not bot.main_window:
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± yok")
            return False

        logger.info(f"ğŸ”˜ DÃ¶nem seÃ§iliyor (index={index})...")

        # DÃ¶nem combobox'Ä±nÄ± bul ve koordinat ile tÄ±kla
        try:
            # TÃ¼m ComboBox'larÄ± bul
            all_combos = bot.main_window.descendants(control_type="ComboBox")

            logger.info(f"Toplam {len(all_combos)} ComboBox bulundu")

            # ComboBox'larÄ± logla
            for i, combo in enumerate(all_combos):
                try:
                    combo_text = combo.window_text()
                    logger.debug(f"ComboBox[{i}]: {combo_text}")
                except Exception as e:
                    logger.debug(f"ComboBox[{i}]: (text okunamadÄ± - {type(e).__name__})")

            donem_combobox = None

            # DÃ¶nem combobox'Ä± genellikle 2. sÄ±rada (index=1)
            if len(all_combos) >= 2:
                donem_combobox = all_combos[1]  # Ä°kinci ComboBox (index=1)
                logger.info("Ä°kinci ComboBox (index=1) dÃ¶nem olarak seÃ§ildi")
            elif len(all_combos) == 1:
                donem_combobox = all_combos[0]  # Tek ComboBox varsa onu kullan
                logger.info("Tek ComboBox bulundu, o kullanÄ±lÄ±yor")
            else:
                logger.error("HiÃ§ ComboBox bulunamadÄ±")

            if donem_combobox:
                # ComboBox'Ä±n koordinatlarÄ±nÄ± al
                rect = donem_combobox.rectangle()
                x_center = (rect.left + rect.right) // 2
                y_center = (rect.top + rect.bottom) // 2

                logger.info(f"DÃ¶nem ComboBox koordinatlarÄ±: x={x_center}, y={y_center}")

                # Koordinata tÄ±kla
                logger.info("DÃ¶nem ComboBox'a tÄ±klanÄ±yor...")
                pyautogui.click(x_center, y_center)
                time.sleep(timing.get("donem_combobox_tiklama"))

                # Ã–nce HOME tuÅŸu ile en baÅŸa dÃ¶n (Ã¶nceki seÃ§im hangi itemdeyse sÄ±fÄ±rlansÄ±n)
                logger.info("HOME tuÅŸu ile en baÅŸa dÃ¶nÃ¼lÃ¼yor...")
                pyautogui.press('home')
                time.sleep(0.3)

                # Index kadar DOWN tuÅŸuna bas
                if index > 0:
                    logger.info(f"{index} kere DOWN tuÅŸuna basÄ±lÄ±yor...")
                    for i in range(index):
                        pyautogui.press('down')
                        time.sleep(0.2)
                else:
                    logger.info("Index 0, birinci dÃ¶nem seÃ§ilecek")

                # Enter ile seÃ§
                logger.info("Enter basÄ±larak dÃ¶nem seÃ§iliyor...")
                pyautogui.press("enter")
                time.sleep(timing.get("donem_secim"))
                logger.info(f"âœ“ DÃ¶nem seÃ§ildi (index: {index})")
                return True
            else:
                logger.error("âŒ DÃ¶nem ComboBox bulunamadÄ±")
                return False

        except Exception as e:
            logger.error(f"âŒ DÃ¶nem seÃ§imi hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    except Exception as e:
        logger.error(f"âŒ DÃ¶nem seÃ§me hatasÄ±: {e}")
        return False


def grup_butonuna_tikla(bot, grup):
    """
    A/B/C grup butonuna tÄ±kla

    Args:
        bot: BotanikBot instance
        grup: "A", "B" veya "C"

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        if not bot or not bot.main_window:
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± yok")
            return False

        logger.debug(f"{grup} grubu butonu aranÄ±yor...")

        # Grup butonunu bul ve tÄ±kla
        grup_mapping = {
            "A": "A",
            "B": "B",
            "C": "C SÄ±ralÄ±"
        }

        grup_text = grup_mapping.get(grup.upper())
        if not grup_text:
            logger.error(f"âŒ GeÃ§ersiz grup: {grup}")
            return False

        try:
            # Text elementi bul
            grup_elements = bot.main_window.descendants(title=grup_text, control_type="Text")
            if grup_elements and len(grup_elements) > 0:
                # Text elementinin parent'Ä±na tÄ±kla (DataItem veya baÅŸka bir container olabilir)
                try:
                    # Text'in kendisine tÄ±klayalÄ±m
                    grup_elements[0].click_input()
                    logger.info(f"âœ“ {grup} grubu butonuna tÄ±klandÄ±")
                    time.sleep(timing.get("grup_butonu_tiklama"))
                    time.sleep(timing.get("grup_sorgulama"))
                    return True
                except Exception as e:
                    logger.debug(f"Grup button click failed: {type(e).__name__}")
                    # Parent'a tÄ±klamayÄ± dene
                    parent = grup_elements[0].parent()
                    parent.click_input()
                    logger.info(f"âœ“ {grup} grubu butonuna tÄ±klandÄ± (parent)")
                    time.sleep(timing.get("grup_butonu_tiklama"))
                    time.sleep(timing.get("grup_sorgulama"))
                    return True
        except Exception as e:
            logger.debug(f"Text elementi ile bulunamadÄ±: {e}")

        logger.error(f"âŒ {grup} grubu butonu bulunamadÄ±")
        return False
    except Exception as e:
        logger.error(f"âŒ Grup butonu tÄ±klama hatasÄ±: {e}")
        return False


def bulunamadi_mesaji_kontrol(bot):
    """
    "Bu dÃ¶neme ait sonlandÄ±rÄ±lmamÄ±ÅŸ reÃ§ete bulunamadÄ±" mesajÄ±nÄ± kontrol et

    Args:
        bot: BotanikBot instance

    Returns:
        bool: Mesaj varsa True
    """
    try:
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        if not bot or not bot.main_window:
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± yok")
            return False

        logger.debug("ğŸ” 'Bu dÃ¶neme ait sonlandÄ±rÄ±lmamÄ±ÅŸ reÃ§ete bulunamadÄ±' mesajÄ± aranÄ±yor...")

        time.sleep(timing.get("bulunamadi_mesaji_kontrol"))

        # "Bu dÃ¶neme ait sonlandÄ±rÄ±lmamÄ±ÅŸ reÃ§ete bulunamadÄ±" text elementini ara
        try:
            text_elements = bot.main_window.descendants(control_type="Text")
            for text in text_elements:
                try:
                    text_value = text.window_text()
                    if "Bu dÃ¶neme ait sonlandÄ±rÄ±lmamÄ±ÅŸ reÃ§ete bulunamadÄ±" in text_value:
                        logger.info("âœ“ 'Bu dÃ¶neme ait sonlandÄ±rÄ±lmamÄ±ÅŸ reÃ§ete bulunamadÄ±' mesajÄ± bulundu")
                        return True
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")
        except Exception as e:
            logger.debug(f"Text element aramasÄ± hatasÄ±: {e}")

        logger.debug("â„¹ 'Bu dÃ¶neme ait sonlandÄ±rÄ±lmamÄ±ÅŸ reÃ§ete bulunamadÄ±' mesajÄ± bulunamadÄ±")
        return False
    except Exception as e:
        logger.error(f"âŒ BulunamadÄ± mesajÄ± kontrolÃ¼ hatasÄ±: {e}")
        return False


def ilk_recete_ac(bot):
    """
    "Son Ä°ÅŸlem Tarihi" labelinin orta noktasÄ±ndan 26 piksel aÅŸaÄŸÄ±ya tÄ±klayarak ilk reÃ§eteyi aÃ§

    Args:
        bot: BotanikBot instance

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        import pyautogui
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        if not bot or not bot.main_window:
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± yok")
            return False

        logger.info("ğŸ”˜ Ä°lk reÃ§ete aÃ§Ä±lÄ±yor...")

        # "Son Ä°ÅŸlem Tarihi" veya "Son Ä°ÅŸl.Tar." labelini bul
        try:
            # TÃ¼m Text elementlerini tara
            all_texts = bot.main_window.descendants(control_type="Text")

            son_islem_label = None

            for text_elem in all_texts:
                try:
                    text_value = text_elem.window_text()
                    if text_value and "Son Ä°ÅŸl" in text_value:
                        son_islem_label = text_elem
                        logger.info(f"âœ“ Label bulundu: '{text_value}'")
                        break
                except Exception as e:
                    logger.debug(f"Operation failed: {type(e).__name__}")

            if son_islem_label:
                # KoordinatlarÄ± al
                rect = son_islem_label.rectangle()

                # Orta noktayÄ± hesapla
                center_x = (rect.left + rect.right) // 2
                center_y = (rect.top + rect.bottom) // 2

                # 25 piksel aÅŸaÄŸÄ±ya tÄ±kla
                click_x = center_x
                click_y = center_y + 25

                logger.info(f"âœ“ Son Ä°ÅŸlem Tarihi koordinatlarÄ±: ({center_x}, {center_y})")
                logger.info(f"ğŸ–± Ä°lk reÃ§ete tÄ±klanÄ±yor: ({click_x}, {click_y})")

                # Ã‡ift tÄ±kla (reÃ§ete aÃ§mak iÃ§in genellikle Ã§ift tÄ±klama gerekir)
                pyautogui.doubleClick(click_x, click_y)
                time.sleep(timing.get("ilk_recete_tiklama"))
                time.sleep(timing.get("recete_acilma"))

                logger.info("âœ“ Ä°lk reÃ§ete aÃ§Ä±ldÄ±")
                return True
            else:
                logger.error("âŒ 'Son Ä°ÅŸlem Tarihi' label bulunamadÄ±")

                # Alternatif: Ä°lk ListItem'Ä± dene
                logger.debug("Alternatif yÃ¶ntem: Ä°lk ListItem aranÄ±yor...")
                list_items = bot.main_window.descendants(control_type="ListItem")

                if list_items and len(list_items) > 0:
                    first_item = list_items[0]
                    rect = first_item.rectangle()
                    center_x = (rect.left + rect.right) // 2
                    center_y = (rect.top + rect.bottom) // 2

                    logger.info(f"âœ“ Ä°lk ListItem bulundu, Ã§ift tÄ±klanÄ±yor: ({center_x}, {center_y})")
                    pyautogui.doubleClick(center_x, center_y)
                    time.sleep(timing.get("ilk_recete_tiklama"))
                    time.sleep(timing.get("recete_acilma"))
                    return True
                else:
                    logger.error("âŒ ListItem de bulunamadÄ±")
                    return False

        except Exception as e:
            logger.error(f"âŒ Ä°lk reÃ§ete aÃ§ma hatasÄ±: {e}")
            import traceback
            traceback.print_exc()
            return False
    except Exception as e:
        logger.error(f"âŒ Ä°lk reÃ§ete aÃ§ma hatasÄ±: {e}")
        return False


def sonraki_gruba_gec_islemi(bot, sonraki_grup):
    """
    Grup bittiÄŸinde (ReÃ§ete kaydÄ± bulunamadÄ±) sonraki gruba geÃ§iÅŸ iÅŸlemini yapar

    AkÄ±ÅŸ:
    1. Geri DÃ¶n butonuna bas â†’ ReÃ§ete Sorgu EkranÄ±'na dÃ¶n
    2. DÃ¶nem seÃ§ (index=2, bulunamadÄ±ysa index=1)
    3. Grup seÃ§ (sonraki_grup)
    4. Ä°lk reÃ§eteyi aÃ§

    Args:
        bot: BotanikBot instance
        sonraki_grup: "A", "B" veya "C"

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True

    Raises:
        Exception: Herhangi bir adÄ±m baÅŸarÄ±sÄ±z olursa
    """
    try:
        from timing_settings import get_timing_settings

        timing = get_timing_settings()

        if not bot or not bot.main_window:
            logger.error("âŒ Bot baÄŸlantÄ±sÄ± yok")
            raise Exception("Bot baÄŸlantÄ±sÄ± yok")

        logger.info("=" * 60)
        logger.info(f"ğŸ”„ GRUP GEÃ‡Ä°ÅÄ°: {sonraki_grup} grubuna geÃ§iliyor...")
        logger.info("=" * 60)

        # 1. Geri DÃ¶n butonuna bas
        logger.info("1ï¸âƒ£ Geri DÃ¶n butonuna basÄ±lÄ±yor...")
        if not bot.geri_don_butonuna_tikla():
            logger.error("âŒ Geri DÃ¶n butonu baÅŸarÄ±sÄ±z")
            raise Exception("Geri DÃ¶n butonu baÅŸarÄ±sÄ±z")

        logger.info("âœ“ ReÃ§ete Sorgu EkranÄ±'na dÃ¶nÃ¼ldÃ¼")
        time.sleep(timing.get("adim_arasi_bekleme"))

        # Pencereyi yenile
        bot.baglanti_kur("MEDULA", ilk_baglanti=False)

        # 2. DÃ¶nem seÃ§ (Ã¶nce index=2, bulunamadÄ±ysa index=1)
        logger.info("2ï¸âƒ£ DÃ¶nem seÃ§iliyor (index=2)...")
        if not donem_sec(bot, index=2):
            logger.error("âŒ DÃ¶nem seÃ§imi baÅŸarÄ±sÄ±z")
            raise Exception("DÃ¶nem seÃ§imi baÅŸarÄ±sÄ±z")

        logger.info("âœ“ DÃ¶nem seÃ§ildi")
        time.sleep(timing.get("adim_arasi_bekleme"))

        # Pencereyi yenile
        bot.baglanti_kur("MEDULA", ilk_baglanti=False)

        # 3. Grup seÃ§
        logger.info(f"3ï¸âƒ£ {sonraki_grup} grubu seÃ§iliyor...")
        if not grup_butonuna_tikla(bot, sonraki_grup):
            logger.error(f"âŒ {sonraki_grup} grubu seÃ§imi baÅŸarÄ±sÄ±z")
            raise Exception(f"{sonraki_grup} grubu seÃ§imi baÅŸarÄ±sÄ±z")

        logger.info(f"âœ“ {sonraki_grup} grubu seÃ§ildi ve sorgulandÄ±")
        time.sleep(timing.get("adim_arasi_bekleme"))

        # Pencereyi yenile
        bot.baglanti_kur("MEDULA", ilk_baglanti=False)

        # 4. "BulunamadÄ±" mesajÄ± kontrolÃ¼
        logger.info("4ï¸âƒ£ ReÃ§ete varlÄ±ÄŸÄ± kontrol ediliyor...")
        if bulunamadi_mesaji_kontrol(bot):
            # Mesaj var, 2. dÃ¶nemi dene (index=1)
            logger.info("âš  3. dÃ¶nemde reÃ§ete yok, 2. dÃ¶nem deneniyor...")

            # DÃ¶nem seÃ§ (index=1, yani 2. sÄ±radaki)
            if not donem_sec(bot, index=1):
                logger.error("âŒ 2. dÃ¶nem seÃ§imi baÅŸarÄ±sÄ±z")
                raise Exception("2. dÃ¶nem seÃ§imi baÅŸarÄ±sÄ±z")

            logger.info("âœ“ 2. dÃ¶nem seÃ§ildi")
            time.sleep(timing.get("adim_arasi_bekleme"))

            # Pencereyi yenile
            bot.baglanti_kur("MEDULA", ilk_baglanti=False)

            # Grup seÃ§ (tekrar)
            logger.info(f"ğŸ“ {sonraki_grup} grubu (2. dÃ¶nem) seÃ§iliyor...")
            if not grup_butonuna_tikla(bot, sonraki_grup):
                logger.error(f"âŒ {sonraki_grup} grubu (2. dÃ¶nem) seÃ§imi baÅŸarÄ±sÄ±z")
                raise Exception(f"{sonraki_grup} grubu (2. dÃ¶nem) seÃ§imi baÅŸarÄ±sÄ±z")

            logger.info(f"âœ“ {sonraki_grup} grubu (2. dÃ¶nem) seÃ§ildi")
            time.sleep(timing.get("adim_arasi_bekleme"))

            # Pencereyi yenile
            bot.baglanti_kur("MEDULA", ilk_baglanti=False)

            # Tekrar kontrol et
            if bulunamadi_mesaji_kontrol(bot):
                logger.error("âŒ 2. dÃ¶nemde de reÃ§ete bulunamadÄ±")
                raise Exception("2. dÃ¶nemde de reÃ§ete bulunamadÄ±")

        # 5. Ä°lk reÃ§eteyi aÃ§
        logger.info("5ï¸âƒ£ Ä°lk reÃ§ete aÃ§Ä±lÄ±yor...")
        if not ilk_recete_ac(bot):
            logger.error("âŒ Ä°lk reÃ§ete aÃ§Ä±lamadÄ±")
            raise Exception("Ä°lk reÃ§ete aÃ§Ä±lamadÄ±")

        logger.info("âœ“ Ä°lk reÃ§ete aÃ§Ä±ldÄ±")

        # Pencereyi yenile
        bot.baglanti_kur("MEDULA", ilk_baglanti=False)

        # Ä°lk reÃ§ete aÃ§Ä±ldÄ±ktan sonra popup kontrolÃ¼
        time.sleep(0.5)
        try:
            if popup_kontrol_ve_kapat():
                logger.info("âœ“ Ä°lk reÃ§ete popup kapatÄ±ldÄ±")
        except Exception as e:
            logger.warning(f"Popup kontrol hatasÄ±: {e}")

        logger.info("=" * 60)
        logger.info(f"âœ… GRUP GEÃ‡Ä°ÅÄ° BAÅARILI: {sonraki_grup} grubuna geÃ§ildi")
        logger.info("=" * 60)

        return True

    except Exception as e:
        logger.error(f"âŒ Grup geÃ§iÅŸi hatasÄ±: {e}")
        import traceback
        traceback.print_exc()
        raise


def medula_ac_ve_giris_yap(medula_settings):
    """
    MasaÃ¼stÃ¼nden MEDULA'yÄ± aÃ§ ve giriÅŸ yap

    Args:
        medula_settings: MEDULA ayarlarÄ± instance'Ä±

    Returns:
        bool: BaÅŸarÄ±lÄ±ysa True
    """
    try:
        from pywinauto import Desktop
        import pyautogui

        # 1. MEDULA'yÄ± exe path ile baÅŸlat
        logger.info("ğŸ“ MEDULA EXE baÅŸlatÄ±lÄ±yor...")
        import subprocess

        desktop = Desktop(backend="uia")

        medula_exe = medula_settings.get("medula_exe_path")
        if not medula_exe or medula_exe == "":
            logger.error("âŒ MEDULA exe path ayarlanmamÄ±ÅŸ!")
            return False

        try:
            subprocess.Popen([medula_exe])
            logger.info(f"âœ“ MEDULA baÅŸlatÄ±ldÄ±: {medula_exe}")
            time.sleep(8)  # MEDULA'nÄ±n aÃ§Ä±lmasÄ± iÃ§in bekle (5 â†’ 8 saniye, taskkill sonrasÄ± daha fazla zaman gerekir)
        except Exception as e:
            logger.error(f"âŒ MEDULA baÅŸlatÄ±lamadÄ±: {e}")
            return False

        # 2. GiriÅŸ penceresini bekle
        logger.info("â³ MEDULA giriÅŸ penceresi bekleniyor...")
        time.sleep(5)  # GiriÅŸ penceresi iÃ§in ek bekleme (3 â†’ 5 saniye)

        # 3. Aktif kullanÄ±cÄ±nÄ±n bilgilerini al
        aktif_kullanici = medula_settings.get_aktif_kullanici()
        if not aktif_kullanici:
            logger.error("âŒ Aktif kullanÄ±cÄ± bulunamadÄ±!")
            return False

        kullanici_index = aktif_kullanici.get("kullanici_index", 0)
        sifre = aktif_kullanici.get("sifre")
        kullanici_ad = aktif_kullanici.get("ad", "KullanÄ±cÄ±")

        if not sifre:
            logger.error(f"âŒ {kullanici_ad} iÃ§in ÅŸifre ayarlanmamÄ±ÅŸ!")
            return False

        # GiriÅŸ yÃ¶ntemi kontrolÃ¼
        giris_yontemi = medula_settings.get("giris_yontemi", "indeks")
        kullanici_adi_giris = medula_settings.get("kullanici_adi_giris", "")

        if giris_yontemi == "indeks":
            logger.info(f"ğŸ” {kullanici_ad} ile giriÅŸ yapÄ±lÄ±yor (Ä°ndeks yÃ¶ntemi - MEDULA Index: {kullanici_index})")
        else:
            logger.info(f"ğŸ” {kullanici_ad} ile giriÅŸ yapÄ±lÄ±yor (KullanÄ±cÄ± AdÄ± yÃ¶ntemi - MEDULA KullanÄ±cÄ±: {kullanici_adi_giris})")

        # GiriÅŸ penceresini bul
        try:
            giris_window = None
            for window in desktop.windows():
                if "BotanikEOS" in window.window_text():
                    giris_window = window
                    break

            if not giris_window:
                logger.error("âŒ MEDULA giriÅŸ penceresi bulunamadÄ±")
                return False

            logger.info("âœ“ GiriÅŸ penceresi bulundu")

            # GiriÅŸ penceresini aktif hale getir ve odaklan
            try:
                giris_window.set_focus()
                time.sleep(0.5)
            except Exception as e:
                logger.debug(f"Pencere focus hatasÄ± (devam ediliyor): {e}")

            # ComboBox'a tÄ±kla ve kullanÄ±cÄ± seÃ§ (PyAutoGUI ile basit Ã§Ã¶zÃ¼m)
            try:
                # Tab ile combobox'a git
                pyautogui.press("tab")
                time.sleep(0.3)

                # Alt+Down ile dropdown'u aÃ§
                pyautogui.keyDown("alt")
                pyautogui.press("down")
                pyautogui.keyUp("alt")
                time.sleep(0.5)

                # GiriÅŸ yÃ¶ntemine gÃ¶re kullanÄ±cÄ± seÃ§imi
                if giris_yontemi == "kullanici_adi":
                    # KullanÄ±cÄ± adÄ± ile arama
                    if kullanici_adi_giris:
                        logger.info(f"KullanÄ±cÄ± adÄ± yazÄ±lÄ±yor: {kullanici_adi_giris}")
                        pyautogui.typewrite(kullanici_adi_giris, interval=0.1)
                        time.sleep(0.3)
                        pyautogui.press("enter")
                        time.sleep(0.5)
                        logger.info(f"âœ“ KullanÄ±cÄ± seÃ§ildi (ad: {kullanici_adi_giris})")
                    else:
                        logger.warning("KullanÄ±cÄ± adÄ± girilmemiÅŸ, varsayÄ±lan kullanÄ±cÄ± seÃ§ilecek")
                        pyautogui.press("enter")
                        time.sleep(0.5)
                else:
                    # Ä°ndeks ile seÃ§im (mevcut yÃ¶ntem)
                    logger.info(f"Combobox'tan {kullanici_ad} seÃ§iliyor (Index: {kullanici_index})...")
                    for i in range(kullanici_index):
                        pyautogui.press("down")
                        time.sleep(0.1)

                    pyautogui.press("enter")  # SeÃ§
                    time.sleep(0.5)
                    logger.info(f"âœ“ {kullanici_ad} seÃ§ildi")
            except Exception as e:
                logger.warning(f"âš  ComboBox iÅŸlemi baÅŸarÄ±sÄ±z: {e}")

            # Åifre textbox'Ä±na yaz
            try:
                # KullanÄ±cÄ± seÃ§ildikten sonra 2 kez Tab ile ÅŸifre alanÄ±na git
                pyautogui.press("tab")
                time.sleep(0.2)
                pyautogui.press("tab")
                time.sleep(0.3)
                logger.info("âœ“ Åifre alanÄ±na gidildi (2x Tab)")

                # Åifre alanÄ±nÄ± temizle (varsa eski ÅŸifre)
                pyautogui.hotkey('ctrl', 'a')
                time.sleep(0.1)
                pyautogui.press('backspace')
                time.sleep(0.2)

                # Åifreyi karakter karakter yaz
                pyautogui.write(sifre, interval=0.05)
                time.sleep(0.5)
                logger.info("âœ“ Åifre girildi")

                # ENTER tuÅŸuna bas
                pyautogui.press("enter")
                time.sleep(4)

                # GiriÅŸ baÅŸarÄ±lÄ± mÄ± kontrol et
                from pywinauto import Desktop
                desktop = Desktop(backend="uia")

                # 5 saniye boyunca MEDULA ana penceresini bekle
                medula_bulundu = False
                for bekleme in range(10):  # 10 * 0.5 = 5 saniye
                    for window in desktop.windows():
                        try:
                            window_text = window.window_text()
                            if "MEDULA" in window_text and "BotanikEOS" not in window_text:
                                logger.info("âœ“ GiriÅŸ yapÄ±ldÄ± - MEDULA ana penceresi aÃ§Ä±ldÄ±")
                                medula_bulundu = True
                                return True
                        except Exception as e:
                            logger.debug(f"Operation failed: {type(e).__name__}")
                    if medula_bulundu:
                        break
                    time.sleep(0.5)

                # GiriÅŸ penceresi hala aÃ§Ä±ksa ÅŸifre yanlÄ±ÅŸ demektir
                for window in desktop.windows():
                    try:
                        if "BotanikEOS" in window.window_text():
                            logger.error("âŒ GiriÅŸ baÅŸarÄ±sÄ±z - Åifre yanlÄ±ÅŸ olabilir")
                            return False
                    except Exception as e:
                        logger.debug(f"Operation failed: {type(e).__name__}")

                logger.warning("âš  GiriÅŸ durumu belirsiz")
                return False

            except Exception as e:
                logger.error(f"âŒ Åifre giriÅŸi baÅŸarÄ±sÄ±z: {e}")
                return False

        except Exception as e:
            logger.error(f"âŒ GiriÅŸ iÅŸlemi baÅŸarÄ±sÄ±z: {e}")
            return False

        return False
    except Exception as e:
        logger.error(f"âŒ MEDULA aÃ§ma/giriÅŸ hatasÄ±: {e}")
        return False


if __name__ == "__main__":
    main()
